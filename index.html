<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>School Management System - Bethel Junior School</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <style>
        :root {
            --primary: #1a73e8;
            --primary-light: #e8f0fe;
            --secondary: #f8f9fa;
            --text: #202124;
            --text-light: #5f6368;
            --success: #34a853;
            --warning: #f9ab00;
            --danger: #ea4335;
            --white: #ffffff;
            --gray: #dadce0;
            --dark-gray: #3c4043;
            --dark-bg: #202124;
            --dark-card: #2d2e30;
            --dark-text: #e8eaed;
            --border-radius: 8px;
            --shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .dark-theme {
            --primary: #8ab4f8;
            --primary-light: #1e3a5f;
            --secondary: #292a2d;
            --text: #e8eaed;
            --text-light: #9aa0a6;
            --success: #81c995;
            --warning: #fdd663;
            --danger: #f28b82;
            --white: #292a2d;
            --gray: #5f6368;
            --dark-gray: #e8eaed;
            --dark-bg: #202124;
            --dark-card: #2d2e30;
            --dark-text: #e8eaed;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        body {
            background-color: var(--secondary);
            color: var(--text);
            transition: var(--transition);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Login Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary) 0%, #6c5ce7 100%);
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .login-container::before {
            content: '';
            position: absolute;
            width: 300%;
            height: 300%;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .login-card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 480px;
            padding: 50px 40px;
            text-align: center;
            transition: var(--transition);
            position: relative;
            z-index: 1;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .login-logo {
            margin-bottom: 40px;
        }

        .logo-image {
            height: 80px;
            margin-bottom: 20px;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
        }

        .login-logo h1 {
            font-size: 28px;
            color: var(--primary);
            margin-bottom: 10px;
            font-weight: 700;
            background: linear-gradient(45deg, var(--primary), #6c5ce7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .login-logo p {
            color: var(--text-light);
            font-size: 16px;
            letter-spacing: 0.5px;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .login-input-group {
            text-align: left;
            position: relative;
        }

        .login-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .login-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid var(--gray);
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: var(--transition);
            background-color: var(--white);
            color: var(--text);
        }

        .login-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
            transform: translateY(-2px);
        }

        .password-container {
            position: relative;
        }

        .toggle-password {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            font-size: 18px;
            transition: var(--transition);
        }

        .toggle-password:hover {
            color: var(--primary);
        }

        .remember-forgot {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        .remember-me {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-light);
        }

        .forgot-password {
            color: var(--primary);
            text-decoration: none;
            font-size: 14px;
            transition: var(--transition);
        }

        .forgot-password:hover {
            text-decoration: underline;
        }

        .login-button {
            width: 100%;
            padding: 16px 20px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            background: linear-gradient(45deg, var(--primary), #6c5ce7);
            color: white;
            box-shadow: 0 4px 15px rgba(26, 115, 232, 0.3);
        }

        .login-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(26, 115, 232, 0.4);
        }

        .login-button:active:not(:disabled) {
            transform: translateY(-1px);
        }

        .login-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .login-footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--gray);
            font-size: 14px;
            color: var(--text-light);
        }

        .login-error {
            background: rgba(244, 67, 54, 0.1);
            color: var(--danger);
            padding: 12px 15px;
            border-radius: var(--border-radius);
            margin-top: 15px;
            display: none;
            align-items: center;
            gap: 10px;
            border-left: 4px solid var(--danger);
            text-align: left;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: var(--white);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Mobile Header */
        .mobile-header {
            display: none;
            padding: 15px 20px;
            background-color: var(--white);
            box-shadow: var(--shadow);
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .mobile-menu-btn {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text);
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .mobile-menu-btn:hover {
            background-color: var(--primary-light);
        }

        .mobile-logo {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary);
        }

        /* Sidebar Styles */
        .sidebar {
            width: 280px;
            background-color: var(--white);
            box-shadow: var(--shadow);
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            z-index: 100;
        }

        .sidebar-header {
            padding: 30px 20px;
            border-bottom: 1px solid var(--gray);
            text-align: center;
            background: linear-gradient(45deg, var(--primary), #6c5ce7);
        }

        .sidebar-header h2 {
            font-size: 20px;
            color: white;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            color: rgba(255,255,255,0.8);
            font-size: 14px;
        }

        .sidebar-menu {
            flex: 1;
            padding: 20px 0;
        }

        .menu-item {
            padding: 15px 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text);
            text-decoration: none;
            border-left: 4px solid transparent;
            margin: 5px 15px;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
        }

        .menu-item:hover {
            background-color: var(--primary-light);
            color: var(--primary);
            transform: translateX(5px);
        }

        .menu-item.active {
            background-color: var(--primary-light);
            color: var(--primary);
            border-left: 4px solid var(--primary);
            font-weight: 600;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid var(--gray);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary), #6c5ce7);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            font-size: 15px;
        }

        .user-role {
            font-size: 13px;
            color: var(--text-light);
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            background-color: var(--secondary);
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--gray);
            flex-wrap: wrap;
            gap: 15px;
        }

        .page-title h1 {
            font-size: 24px;
            color: var(--text);
            font-weight: 700;
            background: linear-gradient(45deg, var(--primary), var(--text));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .page-title p {
            color: var(--text-light);
            margin-top: 8px;
            font-size: 14px;
        }

        /* Level Cards Container */
        .levels-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .level-card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            cursor: pointer;
            border-left: 5px solid var(--primary);
            position: relative;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .level-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }

        .level-card.active {
            background-color: var(--primary-light);
            border-left-color: var(--success);
        }

        .level-name {
            font-weight: 700;
            font-size: 18px;
            color: var(--text);
            margin-bottom: 8px;
        }

        .level-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        .student-count {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
        }

        .student-label {
            font-size: 12px;
            color: var(--text-light);
        }

        .level-fees {
            font-size: 14px;
            color: var(--success);
            font-weight: 600;
        }

        .level-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--success);
        }

        .level-indicator.active {
            background-color: var(--primary);
        }

        /* Updated Students Container */
        .students-container {
            flex: 1;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 15px;
            max-height: calc(100vh - 320px);
            padding: 5px;
        }

        .student-card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            cursor: pointer;
            border-left: 4px solid var(--gray);
            position: relative;
            overflow: hidden;
            height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .student-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }

        .student-card.owing {
            border-left-color: var(--danger);
        }

        .student-card.paid {
            border-left-color: var(--success);
        }

        .student-card.advance {
            border-left-color: var(--warning);
        }

        .student-id-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--primary-light);
            color: var(--primary);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .student-actions {
            position: absolute;
            top: 45px;
            right: 15px;
            display: flex;
            gap: 8px;
        }

        .student-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            font-size: 14px;
        }

        .student-action-btn.edit {
            color: var(--primary);
            background-color: var(--primary-light);
        }

        .student-action-btn.delete {
            color: var(--danger);
            background-color: rgba(234, 67, 53, 0.1);
        }

        .student-action-btn:hover {
            transform: translateY(-2px);
        }

        .student-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            padding-right: 70px;
        }

        .student-name {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 5px;
            line-height: 1.3;
            max-width: 100%;
        }

        .student-level {
            color: var(--text-light);
            font-size: 13px;
            background: var(--primary-light);
            padding: 3px 8px;
            border-radius: 10px;
            display: inline-block;
        }

        .student-details-small {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 5px;
            line-height: 1.4;
        }

        .student-amount {
            font-weight: 800;
            font-size: 18px;
            text-align: right;
        }

        .student-amount.owing {
            color: var(--danger);
        }

        .student-amount.paid {
            color: var(--success);
        }

        .student-amount.advance {
            color: var(--warning);
        }

        .progress-bar {
            height: 6px;
            background-color: var(--gray);
            border-radius: 3px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .progress-fill.owing {
            background: linear-gradient(90deg, var(--danger), #ff7675);
        }

        .progress-fill.paid {
            background: linear-gradient(90deg, var(--success), #00b894);
        }

        .progress-fill.advance {
            background: linear-gradient(90deg, var(--warning), #fdcb6e);
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-light);
        }

        /* Dashboard Controls */
        .dashboard-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .back-btn {
            padding: 10px 20px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
        }

        .back-btn:hover {
            background-color: #0d62d9;
            transform: translateY(-2px);
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border-top: 4px solid var(--primary);
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }

        .stat-card.owing {
            border-top-color: var(--danger);
        }

        .stat-card.paid {
            border-top-color: var(--success);
        }

        .stat-card.advance {
            border-top-color: var(--warning);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 5px;
            line-height: 1;
        }

        .stat-label {
            color: var(--text-light);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 5px;
        }

        /* Search Container */
        .search-container {
            margin-bottom: 20px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px 20px 12px 45px;
            border: 2px solid var(--gray);
            border-radius: var(--border-radius);
            font-size: 15px;
            transition: var(--transition);
            background-color: var(--white);
            color: var(--text);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }

        /* Filters Container */
        .filters-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid var(--gray);
            border-radius: var(--border-radius);
            background-color: var(--white);
            color: var(--text);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            font-size: 14px;
        }

        .filter-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .filter-btn.active {
            background: linear-gradient(45deg, var(--primary), #6c5ce7);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 15px rgba(26, 115, 232, 0.3);
        }

        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Form Styles */
        .form-section {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--shadow);
            max-width: 700px;
            margin: 0 auto;
            width: 100%;
        }

        .form-title {
            margin-bottom: 25px;
            font-size: 22px;
            color: var(--text);
            font-weight: 700;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--gray);
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-col {
            flex: 1;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        /* Custom Fees Dropdown */
        .custom-fees-container {
            margin-top: 10px;
            padding: 15px;
            background-color: var(--primary-light);
            border-radius: var(--border-radius);
            border: 2px dashed var(--primary);
        }

        .custom-fees-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .custom-fees-toggle input {
            width: 20px;
            height: 20px;
        }

        .custom-fees-toggle label {
            font-weight: 600;
            color: var(--primary);
            cursor: pointer;
        }

        .custom-fees-input {
            display: none;
        }

        .custom-fees-input.active {
            display: block;
        }

        /* Statement Modal */
        .statement-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            backdrop-filter: blur(5px);
        }

        .statement-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .statement-content {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 30px;
            max-width: 800px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            transform: translateY(-30px);
            transition: var(--transition);
            position: relative;
        }

        .statement-modal.active .statement-content {
            transform: translateY(0);
        }

        .statement-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-light);
            cursor: pointer;
            transition: var(--transition);
            z-index: 1;
        }

        .statement-close:hover {
            color: var(--danger);
            transform: rotate(90deg);
        }

        .statement-header {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--gray);
        }

        .statement-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 10px;
        }

        .student-details {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 12px;
            color: var(--text-light);
            margin-bottom: 3px;
        }

        .detail-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }

        .statement-summary {
            background: var(--primary-light);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-label {
            font-size: 12px;
            color: var(--text-light);
            margin-bottom: 5px;
        }

        .summary-value {
            font-size: 18px;
            font-weight: 700;
        }

        .summary-value.owing {
            color: var(--danger);
        }

        .summary-value.paid {
            color: var(--success);
        }

        .summary-value.advance {
            color: var(--warning);
        }

        .statement-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .action-btn.primary {
            background: linear-gradient(45deg, var(--primary), #6c5ce7);
            color: white;
        }

        .action-btn.secondary {
            background-color: var(--gray);
            color: var(--text);
        }

        .action-btn.danger {
            background-color: rgba(234, 67, 53, 0.1);
            color: var(--danger);
        }

        .action-btn:hover {
            transform: translateY(-2px);
        }

        .transactions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .transactions-table th {
            background-color: var(--primary-light);
            color: var(--primary);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--gray);
            font-size: 14px;
            position: sticky;
            top: 0;
        }

        .transactions-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--gray);
            font-size: 13px;
        }

        .transactions-table tr:hover {
            background-color: var(--primary-light);
        }

        .transaction-actions {
            display: flex;
            gap: 5px;
        }

        .transaction-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .transaction-btn.delete {
            background-color: rgba(234, 67, 53, 0.1);
            color: var(--danger);
        }

        .transaction-btn.download {
            background-color: rgba(52, 168, 83, 0.1);
            color: var(--success);
        }

        .transaction-btn:hover {
            transform: translateY(-1px);
        }

        .no-transactions {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        .no-transactions i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            backdrop-filter: blur(5px);
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            transform: translateY(-30px);
            transition: var(--transition);
            position: relative;
        }

        .modal.active .modal-content {
            transform: translateY(0);
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-light);
            cursor: pointer;
            transition: var(--transition);
        }

        .modal-close:hover {
            color: var(--danger);
            transform: rotate(90deg);
        }

        .modal-icon {
            font-size: 60px;
            margin-bottom: 25px;
        }

        .modal-icon.success {
            color: var(--success);
        }

        .modal-icon.error {
            color: var(--danger);
        }

        .modal-icon.warning {
            color: var(--warning);
        }

        .modal-title {
            font-size: 24px;
            margin-bottom: 15px;
            font-weight: 700;
            color: var(--text);
        }

        .modal-message {
            color: var(--text-light);
            margin-bottom: 25px;
            line-height: 1.6;
        }

        /* Hidden Sections */
        .section {
            display: none;
            flex: 1;
            overflow-y: auto;
        }

        .section.active {
            display: flex;
            flex-direction: column;
        }

        /* Alert Modal */
        .alert-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }

        .alert-modal.active {
            display: flex;
        }

        .alert-content {
            background: var(--white);
            padding: 30px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .alert-icon {
            font-size: 3rem;
            margin-bottom: 20px;
        }

        .alert-icon.success {
            color: var(--success);
        }

        .alert-icon.error {
            color: var(--danger);
        }

        .alert-icon.warning {
            color: var(--warning);
        }

        .alert-icon.info {
            color: var(--primary);
        }

        .alert-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text);
        }

        .alert-message {
            color: var(--text-light);
            margin-bottom: 20px;
            line-height: 1.5;
        }

        /* Overlay for mobile menu */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
            backdrop-filter: blur(3px);
        }

        .overlay.active {
            display: block;
        }

        /* Toastr Customization */
        .toast-success {
            background: linear-gradient(45deg, var(--success), #00b894) !important;
        }

        .toast-error {
            background: linear-gradient(45deg, var(--danger), #e84393) !important;
        }

        .toast-warning {
            background: linear-gradient(45deg, var(--warning), #fdcb6e) !important;
        }

        .toast-info {
            background: linear-gradient(45deg, var(--primary), #6c5ce7) !important;
        }

        /* Loading Spinner */
        .spinner-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--gray);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
            grid-column: 1 / -1;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .mobile-header {
                display: flex;
            }
            
            .sidebar {
                position: fixed;
                top: 0;
                left: -100%;
                height: 100vh;
                width: 300px;
                transition: var(--transition);
                z-index: 1000;
            }
            
            .sidebar.active {
                left: 0;
            }
            
            .main-content {
                padding: 15px;
                height: calc(100vh - 60px);
            }
            
            .students-container {
                grid-template-columns: 1fr;
                max-height: calc(100vh - 350px);
            }
            
            .levels-container {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stats-container {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stat-card {
                padding: 15px;
                min-height: 100px;
            }
            
            .stat-value {
                font-size: 28px;
            }
            
            .stat-label {
                font-size: 13px;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .dashboard-controls {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .level-card {
                min-height: 100px;
            }
            
            .level-name {
                font-size: 16px;
            }
            
            .student-count {
                font-size: 20px;
            }
        }

        @media (max-width: 480px) {
            .levels-container {
                grid-template-columns: 1fr;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .student-card {
                height: 170px;
            }
            
            .student-name {
                font-size: 15px;
            }
            
            .student-amount {
                font-size: 16px;
            }
            
            .page-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, var(--primary), #6c5ce7);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(45deg, var(--success), #00b894);
            color: white;
        }
        
        .btn-secondary {
            background-color: var(--gray);
            color: var(--text);
        }
    </style>
</head>
<body class="light-theme">
    <!-- Login Modal -->
    <div id="loginModal" class="login-container">
        <div class="login-card">
            <div class="login-logo">
                <img src="logo.png" alt="Bethel Junior School Logo" class="logo-image">
                <h1>School Management System</h1>
                <p>Bethel Junior School - Excellence in Education</p>
            </div>
            
            <div class="login-form">
                <div class="login-input-group">
                    <label class="login-label">Username</label>
                    <input type="text" id="username" class="login-input" placeholder="Enter your username" autocomplete="username">
                </div>
                
                <div class="login-input-group">
                    <label class="login-label">Password</label>
                    <div class="password-container">
                        <input type="password" id="password" class="login-input" placeholder="Enter your password" autocomplete="current-password">
                        <button type="button" class="toggle-password" id="toggle-password">
                            <i class="far fa-eye"></i>
                        </button>
                    </div>
                </div>
                
                <div class="remember-forgot">
                    <label class="remember-me">
                        <input type="checkbox" id="remember-me">
                        <span>Remember me</span>
                    </label>
                    <a href="#" class="forgot-password">Forgot Password?</a>
                </div>
                
                <div class="login-error" id="loginError">
                    <i class="fas fa-exclamation-circle"></i>
                    <span id="loginErrorText">Network error. Please try again.</span>
                </div>
                
                <button class="login-button" onclick="login()" id="loginBtn">
                    <span id="loginBtnText">Sign In</span>
                    <div class="loading-spinner" id="loginLoading" style="display: none;"></div>
                </button>
            </div>
            
            <div class="login-footer">
                <p>Â© 2024 Bethel Junior School. All rights reserved.</p>
                <p>Version 2.0</p>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app-section" class="container" style="display: none;">
        <!-- Mobile Header -->
        <div class="mobile-header">
            <button class="mobile-menu-btn" id="mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </button>
            <div class="mobile-logo">School Management</div>
            <div></div>
        </div>

        <!-- Overlay for mobile menu -->
        <div class="overlay" id="overlay"></div>

        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>School Management System</h2>
                <p>Bethel Junior School</p>
            </div>
            <div class="sidebar-menu">
                <a class="menu-item active" data-section="dashboard">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a class="menu-item" data-section="enroll">
                    <i class="fas fa-user-plus"></i>
                    <span>Enroll Student</span>
                </a>
                <a class="menu-item" data-section="payment">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>Receive Payment</span>
                </a>
                <a class="menu-item" data-section="manage-levels">
                    <i class="fas fa-graduation-cap"></i>
                    <span>Manage Levels</span>
                </a>
                <a class="menu-item" data-section="theme">
                    <i class="fas fa-palette"></i>
                    <span>Theme</span>
                </a>
                <a class="menu-item" data-section="settings">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
                <a class="menu-item" id="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </a>
            </div>
            <div class="sidebar-footer">
                <div class="user-avatar" id="user-avatar">A</div>
                <div class="user-info">
                    <div class="user-name" id="user-name">Administrator</div>
                    <div class="user-role" id="user-role">System Admin</div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Section -->
            <div id="dashboard" class="section active">
                <div class="page-header">
                    <div class="page-title">
                        <h1>Student Fees Dashboard</h1>
                        <p>Monitor student payments and outstanding balances</p>
                    </div>
                    <div class="last-update" id="last-update">
                        Last updated: <span id="update-time">Just now</span>
                    </div>
                </div>

                <!-- Dashboard Controls -->
                <div class="dashboard-controls">
                    <button class="back-btn" id="back-to-levels" style="display: none;">
                        <i class="fas fa-arrow-left"></i> Back to All Levels
                    </button>
                    <div class="header-actions">
                        <button class="btn btn-primary" id="refresh-btn">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn btn-success" id="export-all-btn">
                            <i class="fas fa-file-pdf"></i> Export Report
                        </button>
                    </div>
                </div>

                <!-- Search Container -->
                <div class="search-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="search-input" class="search-input" placeholder="Search students by name, ID, or level...">
                </div>

                <!-- Filters -->
                <div class="filters-container">
                    <button class="filter-btn active" data-filter="all">All Students</button>
                    <button class="filter-btn" data-filter="owing">Owing</button>
                    <button class="filter-btn" data-filter="paid">Fully Paid</button>
                    <button class="filter-btn" data-filter="advance">Advance</button>
                </div>

                <!-- Statistics -->
                <div class="stats-container" id="stats-container">
                    <div class="stat-card">
                        <div class="stat-value" id="total-students">0</div>
                        <div class="stat-label">Total Students</div>
                    </div>
                    <div class="stat-card owing">
                        <div class="stat-value" id="owing-students">0</div>
                        <div class="stat-label">Students Owing</div>
                    </div>
                    <div class="stat-card paid">
                        <div class="stat-value" id="paid-students">0</div>
                        <div class="stat-label">Fully Paid</div>
                    </div>
                    <div class="stat-card advance">
                        <div class="stat-value" id="advance-students">0</div>
                        <div class="stat-label">Advance Payments</div>
                    </div>
                </div>

                <!-- Levels Container -->
                <div class="levels-container" id="levels-container">
                    <!-- Level cards will be dynamically inserted here -->
                    <div class="spinner-container">
                        <div class="spinner"></div>
                    </div>
                </div>

                <!-- Students Container -->
                <div class="students-container" id="students-container" style="display: none;">
                    <!-- Student cards will be dynamically inserted here -->
                </div>
            </div>

            <!-- Enroll Student Section -->
            <div id="enroll" class="section">
                <div class="page-header">
                    <div class="page-title">
                        <h1>Enroll New Student</h1>
                        <p>Add a new student to the system</p>
                    </div>
                </div>

                <div class="form-section">
                    <h2 class="form-title">Student Information</h2>
                    <form id="enroll-form">
                        <div class="login-input-group">
                            <label class="login-label">Full Name *</label>
                            <input type="text" id="enroll-name" class="login-input" placeholder="Enter student's full name" required>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="login-input-group">
                                    <label class="login-label">Grade Level *</label>
                                    <select id="enroll-level" class="login-input" required>
                                        <option value="">Select Grade Level</option>
                                        <!-- Options will be populated from Google Sheets -->
                                    </select>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="login-input-group">
                                    <label class="login-label">Term Fees ($)</label>
                                    <input type="number" id="enroll-term-fees" class="login-input" placeholder="Auto-filled from grade level" readonly>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Custom Fees Section -->
                        <div class="custom-fees-container">
                            <div class="custom-fees-toggle">
                                <input type="checkbox" id="custom-fees-toggle">
                                <label for="custom-fees-toggle">Different Fees for this student</label>
                            </div>
                            <div class="custom-fees-input" id="custom-fees-input">
                                <div class="login-input-group">
                                    <label class="login-label">Custom Term Fees ($)</label>
                                    <input type="number" id="custom-term-fees" class="login-input" placeholder="Enter custom fees amount" min="0" step="0.01">
                                    <small style="color: var(--text-light); font-size: 12px; margin-top: 5px;">
                                        This will override the default fees for this student only
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-col">
                                <div class="login-input-group">
                                    <label class="login-label">Phone Number</label>
                                    <input type="tel" id="enroll-phone" class="login-input" placeholder="Enter student's phone number">
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="login-input-group">
                                    <label class="login-label">Initial Payment ($)</label>
                                    <input type="number" id="enroll-initial-payment" class="login-input" placeholder="Enter initial payment amount" min="0" step="0.01">
                                </div>
                            </div>
                        </div>
                        <div class="login-input-group">
                            <label class="login-label">Address</label>
                            <textarea id="enroll-address" class="login-input" placeholder="Enter student's address" rows="2"></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="login-input-group">
                                    <label class="login-label">Next of Kin</label>
                                    <input type="text" id="enroll-next-of-kin" class="login-input" placeholder="Enter next of kin's name">
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="login-input-group">
                                    <label class="login-label">Next of Kin Phone</label>
                                    <input type="tel" id="enroll-next-of-kin-phone" class="login-input" placeholder="Enter next of kin's phone">
                                </div>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="login-button" id="enroll-btn">
                                <span id="enroll-text">Enroll Student</span>
                                <div class="loading-spinner" id="enroll-loading" style="display: none;"></div>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Receive Payment Section -->
            <div id="payment" class="section">
                <div class="page-header">
                    <div class="page-title">
                        <h1>Receive Payment</h1>
                        <p>Record a payment from a student</p>
                    </div>
                </div>

                <div class="form-section">
                    <h2 class="form-title">Payment Details</h2>
                    <form id="payment-form">
                        <div class="login-input-group">
                            <label class="login-label">Select Student *</label>
                            <input type="text" id="payment-student" class="login-input" placeholder="Type student name or ID..." required>
                            <div id="payment-suggestions" class="suggestions-list"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="login-input-group">
                                    <label class="login-label">Grade Level</label>
                                    <input type="text" id="payment-level" class="login-input" readonly>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="login-input-group">
                                    <label class="login-label">Student ID</label>
                                    <input type="text" id="payment-student-id" class="login-input" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="login-input-group">
                                    <label class="login-label">Amount ($) *</label>
                                    <input type="number" id="payment-amount" class="login-input" placeholder="Enter payment amount" min="0" step="0.01" required>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="login-input-group">
                                    <label class="login-label">Transaction ID</label>
                                    <input type="text" id="payment-tx-id" class="login-input" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="login-input-group">
                            <label class="login-label">Payment Notes (Optional)</label>
                            <textarea id="payment-notes" class="login-input" placeholder="Add any payment notes..." rows="3"></textarea>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="login-button" id="payment-btn">
                                <span id="payment-text">Record Payment</span>
                                <div class="loading-spinner" id="payment-loading" style="display: none;"></div>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Manage Levels Section -->
            <div id="manage-levels" class="section">
                <div class="page-header">
                    <div class="page-title">
                        <h1>Manage Grade Levels</h1>
                        <p>Add, edit, or delete grade levels and set term fees</p>
                    </div>
                    <button class="btn btn-primary" id="add-level-btn">
                        <i class="fas fa-plus"></i> Add Level
                    </button>
                </div>

                <div class="warning-message">
                    <i class="fas fa-exclamation-triangle"></i> Note: Deleting a grade level will not delete students enrolled in that level. Students will retain their current term fees.
                </div>

                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Grade Level</th>
                                <th>Term Fees ($)</th>
                                <th>Number of Students</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="levels-table-body">
                            <!-- Levels will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Theme Section -->
            <div id="theme" class="section">
                <div class="page-header">
                    <div class="page-title">
                        <h1>Theme Settings</h1>
                        <p>Customize the appearance of the system</p>
                    </div>
                </div>

                <div class="form-section">
                    <h2 class="form-title">Select Theme</h2>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="theme-option" data-theme="light">
                                <div class="theme-preview light-preview">
                                    <div class="preview-header"></div>
                                    <div class="preview-sidebar"></div>
                                    <div class="preview-content"></div>
                                </div>
                                <p>Light Theme</p>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="theme-option" data-theme="dark">
                                <div class="theme-preview dark-preview">
                                    <div class="preview-header"></div>
                                    <div class="preview-sidebar"></div>
                                    <div class="preview-content"></div>
                                </div>
                                <p>Dark Theme</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settings" class="section">
                <div class="page-header">
                    <div class="page-title">
                        <h1>System Settings</h1>
                        <p>Configure system preferences</p>
                    </div>
                </div>

                <div class="form-section">
                    <h2 class="form-title">General Settings</h2>
                    <div class="login-input-group">
                        <label class="login-label">School Name</label>
                        <input type="text" id="school-name" class="login-input" value="Bethel Junior School">
                    </div>
                    <div class="login-input-group">
                        <label class="login-label">School Address</label>
                        <textarea id="school-address" class="login-input" rows="3">123 Education Street, Knowledge City</textarea>
                    </div>
                    <div class="login-input-group">
                        <label class="login-label">Contact Phone</label>
                        <input type="text" id="school-phone" class="login-input" value="+1 (555) 123-4567">
                    </div>
                    <div class="form-actions">
                        <button class="login-button" id="save-settings">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Modal -->
    <div class="alert-modal" id="alertModal">
        <div class="alert-content">
            <div class="alert-icon success" id="alertIcon">
                <i class="fas fa-check-circle"></i>
            </div>
            <h3 class="alert-title" id="alertTitle">Success</h3>
            <p class="alert-message" id="alertMessage">Operation completed successfully.</p>
            <button class="login-button" onclick="closeAlertModal()" style="width: 100%; margin-top: 20px;">
                OK
            </button>
        </div>
    </div>

    <!-- Modal for Add/Edit Level -->
    <div id="level-modal" class="modal">
        <div class="modal-content level-form-modal">
            <button class="modal-close" id="level-modal-close">
                <i class="fas fa-times"></i>
            </button>
            <h3 id="level-modal-title" class="modal-title">Add Grade Level</h3>
            <form id="level-form">
                <div class="login-input-group level-form-input">
                    <label class="login-label">Grade Level *</label>
                    <input type="text" id="level-name" class="login-input" placeholder="e.g., Grade 1, Form 1" required>
                </div>
                <div class="login-input-group level-form-input">
                    <label class="login-label">Term Fees ($) *</label>
                    <input type="number" id="level-fees" class="login-input" placeholder="Enter term fees amount" min="0" step="0.01" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="login-button" id="level-btn">
                        <span id="level-text">Save Level</span>
                        <div class="loading-spinner" id="level-loading" style="display: none;"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Statement Modal -->
    <div id="statement-modal" class="statement-modal">
        <div class="statement-content">
            <button class="statement-close" id="statement-modal-close">
                <i class="fas fa-times"></i>
            </button>
            <div class="statement-header">
                <h3 class="statement-title">Student Statement</h3>
                <div class="student-details">
                    <div class="detail-item">
                        <span class="detail-label">Student ID</span>
                        <span class="detail-value" id="statement-student-id"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Name</span>
                        <span class="detail-value" id="statement-name"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Grade Level</span>
                        <span class="detail-value" id="statement-level"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Term Fees</span>
                        <span class="detail-value" id="statement-term-fees"></span>
                    </div>
                </div>
            </div>
            
            <div class="statement-summary">
                <div class="summary-item">
                    <div class="summary-label">Total Paid</div>
                    <div class="summary-value paid" id="statement-total-paid">$0.00</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Total Due</div>
                    <div class="summary-value" id="statement-total-due">$0.00</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Balance</div>
                    <div class="summary-value" id="statement-balance">$0.00</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Status</div>
                    <div class="summary-value" id="statement-status">Paid</div>
                </div>
            </div>
            
            <div class="statement-actions">
                <button class="action-btn primary" id="statement-export-all">
                    <i class="fas fa-file-pdf"></i> Export Full Statement
                </button>
                <button class="action-btn secondary" id="statement-close-btn">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
            
            <div class="table-container">
                <table class="transactions-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Transaction ID</th>
                            <th>Amount</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="statement-transactions">
                        <!-- Transactions will be inserted here -->
                    </tbody>
                </table>
                <div id="no-transactions-message" class="no-transactions" style="display: none;">
                    <i class="fas fa-receipt"></i>
                    <p>No transactions found for this student</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Student Modal -->
    <div id="edit-student-modal" class="modal">
        <div class="modal-content edit-modal">
            <button class="modal-close" id="edit-student-modal-close">
                <i class="fas fa-times"></i>
            </button>
            <h3 class="modal-title">Edit Student Information</h3>
            <form id="edit-student-form" class="edit-form">
                <div class="login-input-group">
                    <label class="login-label">Student ID</label>
                    <input type="text" id="edit-student-id" class="login-input" readonly>
                </div>
                <div class="login-input-group">
                    <label class="login-label">Full Name *</label>
                    <input type="text" id="edit-student-name" class="login-input" placeholder="Enter student's full name" required>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="login-input-group">
                            <label class="login-label">Phone Number</label>
                            <input type="tel" id="edit-student-phone" class="login-input" placeholder="Enter student's phone number">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="login-input-group">
                            <label class="login-label">Grade Level</label>
                            <input type="text" id="edit-student-level" class="login-input" readonly>
                        </div>
                    </div>
                </div>
                <div class="login-input-group">
                    <label class="login-label">Address</label>
                            <textarea id="edit-student-address" class="login-input" placeholder="Enter student's address" rows="2"></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="login-input-group">
                                    <label class="login-label">Next of Kin</label>
                                    <input type="text" id="edit-student-next-of-kin" class="login-input" placeholder="Enter next of kin's name">
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="login-input-group">
                                    <label class="login-label">Next of Kin Phone</label>
                                    <input type="tel" id="edit-student-next-of-kin-phone" class="login-input" placeholder="Enter next of kin's phone">
                                </div>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="login-button" id="edit-student-btn">
                                <span id="edit-student-text">Save Changes</span>
                                <div class="loading-spinner" id="edit-student-loading" style="display: none;"></div>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

<script>
    // Global variables
    let studentsData = [];
    let aggregatedStudents = {};
    let levelsData = [];
    let currentUser = null;
    let pendingRequests = [];
    let currentFilter = 'all';
    let currentSearch = '';
    let selectedStudent = null;
    let isEditingLevel = false;
    let currentLevelId = null;
    let syncInterval = null;
    let isSyncing = false;
    let onlineStatus = navigator.onLine;
    let selectedLevel = null;
    let debounceTimer = null;

    // API URLs
    const API_URL = 'https://script.google.com/macros/s/AKfycbwRxSt5vAeBJfD8NdskjSWMm6nkyXO-bXaf2qDCSo8N-q3tWqQxCkkLjEFS_qAu6eWu/exec';
    const ACCOUNTS_SHEET_ID = '1Hri0wdnRUwEwDYe9KqeIttbskS-PpIjyVrpRDhBUkjY';
    const ACCOUNTS_SHEET_NAME = 'accounts';
    const ACCOUNTS_API_URL = `https://docs.google.com/spreadsheets/d/${ACCOUNTS_SHEET_ID}/gviz/tq?tqx=out:json&tq&sheet=${ACCOUNTS_SHEET_NAME}`;

    // Database
    const DB_NAME = 'bethel';
    const DB_VERSION = 1;
    let db = null;

    // Company details
    const COMPANY_DETAILS = {
        name: 'Bethel Junior School',
        phone: '+263774931989',
        address: 'Harare, Zimbabwe',
        footer: 'By Electrify Technologies | 0719618527'
    };

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
        // Setup online/offline listeners
        window.addEventListener('online', handleOnline);
        window.addEventListener('offline', handleOffline);
        
        // Initialize database
        initDB().then(() => {
            // Check authentication
            checkAuth();
        }).catch(error => {
            console.error('Error initializing database:', error);
            checkAuth(); // Fallback to localStorage
        });

        // Setup event listeners
        setupEventListeners();
        
        // Initialize settings with company details
        initializeSettings();
    });

    // Initialize settings with company details
    function initializeSettings() {
        document.getElementById('school-name').value = COMPANY_DETAILS.name;
        document.getElementById('school-address').value = COMPANY_DETAILS.address;
        document.getElementById('school-phone').value = COMPANY_DETAILS.phone;
    }

    // Initialize IndexedDB
    async function initDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            
            request.onerror = () => reject(request.error);
            request.onsuccess = () => {
                db = request.result;
                resolve(db);
            };
            
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                
                // Create object stores
                if (!db.objectStoreNames.contains('users')) {
                    const usersStore = db.createObjectStore('users', { keyPath: 'username' });
                    usersStore.createIndex('by_timestamp', 'last_login');
                }
                
                if (!db.objectStoreNames.contains('pendingRequests')) {
                    db.createObjectStore('pendingRequests', { keyPath: 'id', autoIncrement: true });
                }
                
                if (!db.objectStoreNames.contains('appState')) {
                    db.createObjectStore('appState', { keyPath: 'key' });
                }
            };
        });
    }

    // Store data in IndexedDB
    async function storeData(storeName, data) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            const request = store.put(data);
            
            request.onerror = () => reject(request.error);
            request.onsuccess = () => resolve(request.result);
        });
    }

    // Get data from IndexedDB
    async function getData(storeName, key) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([storeName], 'readonly');
            const store = transaction.objectStore(storeName);
            const request = store.get(key);
            
            request.onerror = () => reject(request.error);
            request.onsuccess = () => resolve(request.result);
        });
    }

    // Get all data from IndexedDB
    async function getAllData(storeName) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([storeName], 'readonly');
            const store = transaction.objectStore(storeName);
            const request = store.getAll();
            
            request.onerror = () => reject(request.error);
            request.onsuccess = () => resolve(request.result);
        });
    }

    // Delete data from IndexedDB
    async function deleteData(storeName, key) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            const request = store.delete(key);
            
            request.onerror = () => reject(request.error);
            request.onsuccess = () => resolve(request.result);
        });
    }

    // Cache user credentials for offline login
    async function cacheUserCredentials(userData) {
        try {
            await storeData('users', {
                username: userData.username,
                password: userData.password,
                role: userData.role,
                last_login: new Date().toISOString()
            });
            
            // Store as last active user
            await storeData('appState', {
                key: 'last_active_user',
                username: userData.username,
                timestamp: new Date().toISOString()
            });
            
            console.log('User credentials cached for offline login');
        } catch (error) {
            console.error('Error caching user credentials:', error);
        }
    }

    // Get cached user by username
    async function getCachedUser(username) {
        try {
            return await getData('users', username);
        } catch (error) {
            console.error('Error getting cached user:', error);
            return null;
        }
    }

    // Get last active user from cache
    async function getLastActiveUser() {
        try {
            return await getData('appState', 'last_active_user');
        } catch (error) {
            console.error('Error getting last active user:', error);
            return null;
        }
    }

    // Check online status
    function checkOnlineStatus() {
        onlineStatus = navigator.onLine;
        return onlineStatus;
    }

    // Handle online event
    async function handleOnline() {
        onlineStatus = true;
        showAlert('Info', 'Back online! Syncing data...', 'info');
        
        // Try to sync pending requests
        retryPendingRequests();
        
        // Refresh data
        loadStudentsData();
        loadLevelsData();
    }

    // Handle offline event
    function handleOffline() {
        onlineStatus = false;
        showAlert('Info', 'Working offline. Data will sync when connection is restored.', 'info');
    }

    // Enhanced login function
    async function login() {
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        const loginBtn = document.getElementById('loginBtn');
        const loginBtnText = document.getElementById('loginBtnText');
        const loginLoading = document.getElementById('loginLoading');
        const loginError = document.getElementById('loginError');
        const loginErrorText = document.getElementById('loginErrorText');
        const rememberMe = document.getElementById('remember-me').checked;
        
        if (!username || !password) {
            loginErrorText.textContent = 'Please enter both username and password';
            loginError.style.display = 'flex';
            return;
        }
        
        // Show loading state
        loginBtn.disabled = true;
        loginBtnText.style.display = 'none';
        loginLoading.style.display = 'inline-block';
        loginError.style.display = 'none';
        
        try {
            // Always try cached credentials first for faster login
            const cachedUser = await getCachedUser(username);
            
            if (cachedUser && cachedUser.password === password) {
                // Login with cached credentials
                handleSuccessfulLogin(cachedUser, true, rememberMe);
                return;
            }
            
            // If not cached or password doesn't match, try online login
            if (!navigator.onLine) {
                throw new Error('No internet connection and no cached credentials found.');
            }
            
            // Online login with timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000);
            
            try {
                const response = await fetch(ACCOUNTS_API_URL, { signal: controller.signal });
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                let text = await response.text();
                
                // Parse the Google Sheets JSON response
                const jsonStart = text.indexOf('{');
                const jsonEnd = text.lastIndexOf('}') + 1;
                const jsonText = text.substring(jsonStart, jsonEnd);
                
                if (!jsonText) {
                    throw new Error('Invalid response from server');
                }
                
                let json;
                try {
                    json = JSON.parse(jsonText);
                } catch (parseError) {
                    console.error('JSON parse error:', parseError);
                    throw new Error('Invalid data format from server');
                }

                // Extract rows from the Google Sheets format
                let accounts = [];
                if (json.table && json.table.rows) {
                    accounts = json.table.rows.map(row => {
                        const cells = row.c || [];
                        return {
                            username: cells[0]?.v?.toString() || "",
                            password: cells[1]?.v?.toString() || "",
                            role: cells[2]?.v?.toString() || "user"
                        };
                    }).filter(account => account.username && account.password);
                }

                // Find matching user
                const user = accounts.find(acc => 
                    acc.username.toLowerCase() === username.toLowerCase() && 
                    acc.password === password
                );

                if (!user) {
                    throw new Error('Invalid username or password');
                }

                // Cache the user for offline use
                await cacheUserCredentials(user);

                // Login with verified credentials
                handleSuccessfulLogin(user, false, rememberMe);
                
            } catch (fetchError) {
                if (fetchError.name === 'AbortError') {
                    throw new Error('Login timeout. Please check your internet connection.');
                } else {
                    throw fetchError;
                }
            }
            
        } catch (error) {
            console.error('Login error:', error);
            
            let errorMessage = 'Network error. Please try again.';
            if (error.message.includes('internet') || error.message.includes('connection') || error.message.includes('timeout')) {
                errorMessage = error.message;
            } else if (error.message.includes('Invalid data') || error.message.includes('JSON')) {
                errorMessage = 'Server error. Please try again later.';
            } else if (error.message.includes('cached')) {
                errorMessage = 'No internet connection and no valid cached credentials found.';
            } else if (error.message.includes('Invalid username')) {
                errorMessage = 'Invalid username or password';
            }
            
            loginErrorText.textContent = errorMessage;
            loginError.style.display = 'flex';
        } finally {
            // Reset button state
            loginBtn.disabled = false;
            loginBtnText.style.display = 'inline';
            loginLoading.style.display = 'none';
        }
    }

    // Handle successful login
    async function handleSuccessfulLogin(userData, isCachedLogin, rememberMe) {
        currentUser = {
            username: userData.username,
            role: userData.role,
            rememberMe: rememberMe
        };
        
        // Save user data based on remember me preference
        if (rememberMe) {
            localStorage.setItem('school_currentUser', JSON.stringify(currentUser));
        } else {
            sessionStorage.setItem('school_currentUser', JSON.stringify(currentUser));
        }
        
        // Hide login modal and initialize app
        document.getElementById('loginModal').style.display = 'none';
        await initApp();
        
        // Show appropriate message
        if (isCachedLogin) {
            showAlert('Info', 'Logged in with cached credentials', 'info');
        } else {
            showAlert('Success', `Welcome back, ${userData.username}!`, 'success');
        }
    }

    // Check authentication with offline support
    async function checkAuth() {
        try {
            // Try to get from localStorage first (remember me)
            let userData = localStorage.getItem('school_currentUser');
            
            if (!userData) {
                // Try sessionStorage (session only)
                userData = sessionStorage.getItem('school_currentUser');
            }
            
            if (userData) {
                currentUser = JSON.parse(userData);
                
                // Verify user still exists in cache
                const cachedUser = await getCachedUser(currentUser.username);
                if (cachedUser) {
                    document.getElementById('loginModal').style.display = 'none';
                    await initApp();
                    return;
                }
            }
            
            // Try to get last active user from cache
            const lastUser = await getLastActiveUser();
            if (lastUser && navigator.onLine === false) {
                // Auto-login with last user when offline
                currentUser = {
                    username: lastUser.username,
                    role: 'cached',
                    rememberMe: true
                };
                
                localStorage.setItem('school_currentUser', JSON.stringify(currentUser));
                document.getElementById('loginModal').style.display = 'none';
                await initApp();
                showAlert('Info', 'Auto-logged in with last user (offline mode)', 'info');
                return;
            }
            
            // Show login modal
            document.getElementById('loginModal').style.display = 'flex';
            
        } catch (error) {
            console.error('Auth check error:', error);
            document.getElementById('loginModal').style.display = 'flex';
        }
    }

    // Initialize application
    async function initApp() {
        try {
            // Display user info
            if (currentUser) {
                document.getElementById('user-name').textContent = currentUser.username;
                document.getElementById('user-role').textContent = currentUser.role || 'User';
                document.getElementById('user-avatar').textContent = currentUser.username.charAt(0).toUpperCase();
            }
            
            // Load initial data
            await loadStudentsData();
            await loadLevelsData();
            
            // Start sync interval
            startSyncInterval();
            
            // Show main container
            document.getElementById('app-section').style.display = 'flex';
            
        } catch (error) {
            console.error('Error initializing app:', error);
            showAlert('Error', 'Error initializing application. Please refresh the page.', 'error');
        }
    }

    // Set up event listeners
    function setupEventListeners() {
        // Login form enter key
        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });

        // Toggle password visibility
        document.getElementById('toggle-password').addEventListener('click', function() {
            const passwordInput = document.getElementById('password');
            const icon = this.querySelector('i');
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });
        
        // Menu items
        document.querySelectorAll('.menu-item').forEach(item => {
            if (!item.id.includes('logout-btn')) {
                item.addEventListener('click', function() {
                    // Remove active class from all menu items
                    document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                    // Add active class to clicked item
                    this.classList.add('active');
                    // Show corresponding section
                    const sectionId = this.getAttribute('data-section');
                    showSection(sectionId);
                    // Close mobile menu
                    closeMobileMenu();
                });
            }
        });
        
        // Back to levels button
        document.getElementById('back-to-levels').addEventListener('click', function() {
            selectedLevel = null;
            this.style.display = 'none';
            document.getElementById('levels-container').style.display = 'grid';
            document.getElementById('students-container').style.display = 'none';
            document.getElementById('search-input').value = '';
            currentSearch = '';
            updateDashboardTitle();
        });
        
        // Filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentFilter = this.getAttribute('data-filter');
                renderStudents();
            });
        });
        
        // Search input with debounce
        document.getElementById('search-input').addEventListener('input', function() {
            clearTimeout(debounceTimer);
            currentSearch = this.value.toLowerCase();
            debounceTimer = setTimeout(() => {
                renderStudents();
            }, 300);
        });
        
        // Enroll form
        document.getElementById('enroll-form').addEventListener('submit', handleEnroll);
        
        // Custom fees toggle
        document.getElementById('custom-fees-toggle').addEventListener('change', function() {
            const customFeesInput = document.getElementById('custom-fees-input');
            const customFeesField = document.getElementById('custom-term-fees');
            
            if (this.checked) {
                customFeesInput.classList.add('active');
                customFeesField.required = true;
                customFeesField.focus();
            } else {
                customFeesInput.classList.remove('active');
                customFeesField.required = false;
                customFeesField.value = '';
            }
        });
        
        // Level select change in enroll form
        document.getElementById('enroll-level').addEventListener('change', function() {
            const level = levelsData.find(l => l.std_levels === this.value);
            if (level) {
                document.getElementById('enroll-term-fees').value = level.term_fees;
                // Reset custom fees if default level fees is selected
                const customFeesToggle = document.getElementById('custom-fees-toggle');
                if (!customFeesToggle.checked) {
                    document.getElementById('custom-term-fees').value = '';
                }
            }
        });
        
        // Payment form
        document.getElementById('payment-form').addEventListener('submit', handlePayment);
        
        // Payment student input for suggestions
        document.getElementById('payment-student').addEventListener('input', showStudentSuggestions);
        
        // Level form
        document.getElementById('level-form').addEventListener('submit', handleLevelSave);
        
        // Edit student form
        document.getElementById('edit-student-form').addEventListener('submit', handleStudentEdit);
        
        // Theme options
        document.querySelectorAll('.theme-option').forEach(option => {
            option.addEventListener('click', function() {
                const theme = this.getAttribute('data-theme');
                setTheme(theme);
                showAlert('Success', 'Theme updated successfully!', 'success');
            });
        });
        
        // Logout button
        document.getElementById('logout-btn').addEventListener('click', handleLogout);
        
        // Mobile menu button
        document.getElementById('mobile-menu-btn').addEventListener('click', toggleMobileMenu);
        
        // Overlay click to close mobile menu
        document.getElementById('overlay').addEventListener('click', closeMobileMenu);
        
        // Refresh button
        document.getElementById('refresh-btn').addEventListener('click', function() {
            loadStudentsData();
            loadLevelsData();
            showAlert('Success', 'Data refreshed successfully!', 'success');
        });
        
        // Export all button
        document.getElementById('export-all-btn').addEventListener('click', exportAllStudentsData);
        
        // Add level button
        document.getElementById('add-level-btn').addEventListener('click', function() {
            showLevelModal();
        });
        
        // Save settings button
        document.getElementById('save-settings').addEventListener('click', saveSettings);
        
        // Modal close buttons
        document.getElementById('level-modal-close').addEventListener('click', function() {
            document.getElementById('level-modal').classList.remove('active');
            document.getElementById('level-form').reset();
            isEditingLevel = false;
            currentLevelId = null;
        });
        
        // Statement modal close buttons
        document.getElementById('statement-modal-close').addEventListener('click', function() {
            document.getElementById('statement-modal').classList.remove('active');
        });
        
        document.getElementById('statement-close-btn').addEventListener('click', function() {
            document.getElementById('statement-modal').classList.remove('active');
        });
        
        // Edit student modal close button
        document.getElementById('edit-student-modal-close').addEventListener('click', function() {
            document.getElementById('edit-student-modal').classList.remove('active');
        });

        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            const modals = ['level-modal', 'statement-modal', 'edit-student-modal', 'alertModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    modal.classList.remove('active');
                    if (modalId === 'level-modal') {
                        document.getElementById('level-form').reset();
                        isEditingLevel = false;
                        currentLevelId = null;
                    }
                }
            });
        });

        // Close alert modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeAlertModal();
                document.getElementById('level-modal').classList.remove('active');
                document.getElementById('statement-modal').classList.remove('active');
                document.getElementById('edit-student-modal').classList.remove('active');
            }
        });

        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.id !== 'payment-student') {
                document.getElementById('payment-suggestions').style.display = 'none';
            }
        });

        // Prevent page unload if there are pending requests
        window.addEventListener('beforeunload', function(e) {
            if (pendingRequests.length > 0 && !onlineStatus) {
                e.preventDefault();
                e.returnValue = 'You have pending requests that will be saved locally.';
            }
        });
    }

    // Toggle mobile menu
    function toggleMobileMenu() {
        document.getElementById('sidebar').classList.toggle('active');
        document.getElementById('overlay').classList.toggle('active');
    }

    // Close mobile menu
    function closeMobileMenu() {
        document.getElementById('sidebar').classList.remove('active');
        document.getElementById('overlay').classList.remove('active');
    }

    // Show a specific section
    function showSection(sectionId) {
        // Hide all sections
        document.querySelectorAll('.section').forEach(section => {
            section.classList.remove('active');
        });
        
        // Show the selected section
        document.getElementById(sectionId).classList.add('active');
        
        // Load section-specific data
        if (sectionId === 'manage-levels') {
            loadLevelsData();
        } else if (sectionId === 'dashboard') {
            // Reset dashboard view
            selectedLevel = null;
            document.getElementById('back-to-levels').style.display = 'none';
            document.getElementById('levels-container').style.display = 'grid';
            document.getElementById('students-container').style.display = 'none';
            document.getElementById('search-input').value = '';
            currentSearch = '';
            updateDashboardTitle();
        }
    }

    // Update dashboard title based on selection
    function updateDashboardTitle() {
        const titleElement = document.querySelector('#dashboard .page-title h1');
        if (selectedLevel) {
            titleElement.textContent = `Grade ${selectedLevel} Students`;
        } else {
            titleElement.textContent = 'Student Fees Dashboard';
        }
    }

    // Load students data from API
    async function loadStudentsData() {
        try {
            const response = await fetch(`${API_URL}?action=getStudents`);
            const data = await response.json();
            studentsData = data;
            
            // Process the data - aggregate by student_id
            processStudentsData();
            
            // Update statistics
            updateStatistics();
            
            // Render levels
            renderLevelCards();
            
            // Render students if a level is selected
            if (selectedLevel) {
                renderStudents();
            }
            
            // Update last update time
            document.getElementById('update-time').textContent = new Date().toLocaleTimeString();
            
        } catch (error) {
            console.error('Error loading students data:', error);
            showAlert('Error', 'Failed to load student data', 'error');
        }
    }

    // Load levels data from API
    async function loadLevelsData() {
        try {
            const response = await fetch(`${API_URL}?action=getLevels`);
            const data = await response.json();
            levelsData = data;
            
            // Populate level dropdown in enroll form
            const levelSelect = document.getElementById('enroll-level');
            levelSelect.innerHTML = '<option value="">Select Grade Level</option>';
            levelsData.forEach(level => {
                const option = document.createElement('option');
                option.value = level.std_levels;
                option.textContent = level.std_levels;
                levelSelect.appendChild(option);
            });
            
            // Render levels table in manage levels section
            renderLevelsTable();
            
        } catch (error) {
            console.error('Error loading levels data:', error);
            showAlert('Error', 'Failed to load grade levels', 'error');
        }
    }

    // Process students data to calculate totals and status
    function processStudentsData() {
        aggregatedStudents = {}; // Reset aggregated data
        
        // Filter out deleted students
        const activeStudents = studentsData.filter(student => student.delete !== 'yes');
        
        // Group transactions by student_id
        activeStudents.forEach(record => {
            const studentId = record.student_id;
            
            if (!aggregatedStudents[studentId]) {
                // First time seeing this student
                aggregatedStudents[studentId] = {
                    student_id: studentId,
                    name: record.name,
                    level: record.level,
                    termFees: parseFloat(record.term_fees) || 0,
                    std_levels: record.std_levels || record.level,
                    phone: record.phone || '',
                    address: record.address || '',
                    next_of_kin: record.next_of_kin || '',
                    next_of_kin_phone: record.next_of_kin_phone || '',
                    totalPaid: 0,
                    transactions: [],
                    lastUpdated: record.date ? new Date(record.date) : new Date()
                };
            }
            
            // Add payment amount
            const amount = parseFloat(record.amount) || 0;
            aggregatedStudents[studentId].totalPaid += amount;
            
            // Add transaction record
            if (amount > 0 && record.tx_id) {
                aggregatedStudents[studentId].transactions.push({
                    date: record.date ? new Date(record.date) : new Date(),
                    tx_id: record.tx_id,
                    amount: amount,
                    notes: record.notes || ''
                });
            }
            
            // Update last updated date if this record is newer
            const recordDate = record.date ? new Date(record.date) : new Date();
            if (recordDate > aggregatedStudents[studentId].lastUpdated) {
                aggregatedStudents[studentId].lastUpdated = recordDate;
            }
        });
        
        // Convert aggregated data to array and calculate additional fields
        const aggregatedArray = Object.values(aggregatedStudents);
        
        aggregatedArray.forEach(student => {
            student.balance = student.termFees - student.totalPaid;
            
            // Determine status
            if (student.balance > 0) {
                student.status = 'owing';
                student.owingAmount = student.balance;
            } else if (student.balance < 0) {
                student.status = 'advance';
                student.advanceAmount = Math.abs(student.balance);
            } else {
                student.status = 'paid';
            }
            
            // Calculate payment progress
            student.progress = student.termFees > 0 ? Math.min((student.totalPaid / student.termFees) * 100, 100) : 100;
            
            // Sort transactions by date (newest first)
            student.transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
        });
        
        // Store aggregated data for rendering
        studentsData = aggregatedArray;
    }

    // Update statistics
    function updateStatistics() {
        const filteredStudents = selectedLevel 
            ? studentsData.filter(s => s.level === selectedLevel)
            : studentsData;
        
        const total = filteredStudents.length;
        const owing = filteredStudents.filter(s => s.status === 'owing').length;
        const paid = filteredStudents.filter(s => s.status === 'paid').length;
        const advance = filteredStudents.filter(s => s.status === 'advance').length;
        
        document.getElementById('total-students').textContent = total;
        document.getElementById('owing-students').textContent = owing;
        document.getElementById('paid-students').textContent = paid;
        document.getElementById('advance-students').textContent = advance;
    }

    // Render level cards
    function renderLevelCards() {
        const levelsContainer = document.getElementById('levels-container');
        levelsContainer.innerHTML = '';
        
        if (levelsData.length === 0) {
            levelsContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-graduation-cap"></i>
                    <h3>No Grade Levels Found</h3>
                    <p>Add grade levels in the "Manage Levels" section</p>
                </div>
            `;
            return;
        }
        
        // Count students per level
        const levelCounts = {};
        const levelFees = {};
        
        studentsData.forEach(student => {
            if (student.level) {
                levelCounts[student.level] = (levelCounts[student.level] || 0) + 1;
                levelFees[student.level] = student.termFees;
            }
        });
        
        // Sort levels by name
        const sortedLevels = levelsData.sort((a, b) => {
            const aNum = parseInt(a.std_levels.replace(/[^0-9]/g, '')) || 0;
            const bNum = parseInt(b.std_levels.replace(/[^0-9]/g, '')) || 0;
            return aNum - bNum;
        });
        
        sortedLevels.forEach(level => {
            const levelName = level.std_levels;
            const studentCount = levelCounts[levelName] || 0;
            const fees = parseFloat(level.term_fees) || 0;
            
            const levelCard = document.createElement('div');
            levelCard.className = `level-card ${selectedLevel === levelName ? 'active' : ''}`;
            
            levelCard.innerHTML = `
                <div class="level-indicator ${studentCount > 0 ? 'active' : ''}"></div>
                <div class="level-name">${levelName}</div>
                <div class="level-stats">
                    <div>
                        <div class="student-count">${studentCount}</div>
                        <div class="student-label">Student${studentCount !== 1 ? 's' : ''}</div>
                    </div>
                    <div class="level-fees">$${fees.toFixed(2)}</div>
                </div>
            `;
            
            levelCard.addEventListener('click', function() {
                selectLevel(levelName);
            });
            
            levelsContainer.appendChild(levelCard);
        });
    }

    // Select a level to view its students
    function selectLevel(levelName) {
        selectedLevel = levelName;
        
        // Update UI
        document.getElementById('back-to-levels').style.display = 'flex';
        document.getElementById('levels-container').style.display = 'none';
        document.getElementById('students-container').style.display = 'grid';
        
        // Update dashboard title
        updateDashboardTitle();
        
        // Render students for this level
        renderStudents();
        
        // Update statistics for this level
        updateStatistics();
    }

    // Render students based on current filter, search, and selected level
    function renderStudents() {
        const studentsContainer = document.getElementById('students-container');
        studentsContainer.innerHTML = '';
        
        let filteredStudents = studentsData;
        
        // Apply level filter
        if (selectedLevel) {
            filteredStudents = filteredStudents.filter(student => student.level === selectedLevel);
        }
        
        // Apply status filter
        if (currentFilter !== 'all') {
            filteredStudents = filteredStudents.filter(student => student.status === currentFilter);
        }
        
        // Apply search
        if (currentSearch) {
            filteredStudents = filteredStudents.filter(student => 
                student.name.toLowerCase().includes(currentSearch) || 
                student.student_id.toLowerCase().includes(currentSearch) ||
                student.phone.toLowerCase().includes(currentSearch) ||
                (student.next_of_kin && student.next_of_kin.toLowerCase().includes(currentSearch))
            );
        }
        
        // Sort by name
        filteredStudents.sort((a, b) => a.name.localeCompare(b.name));
        
        // Render student cards
        filteredStudents.forEach(student => {
            const studentCard = document.createElement('div');
            studentCard.className = `student-card ${student.status}`;
            
            let statusText = '';
            let statusClass = '';
            
            if (student.status === 'owing') {
                statusText = `$${student.owingAmount.toFixed(2)} Owing`;
                statusClass = 'owing';
            } else if (student.status === 'advance') {
                statusText = `$${student.advanceAmount.toFixed(2)} Advance`;
                statusClass = 'advance';
            } else {
                statusText = 'Fully Paid';
                statusClass = 'paid';
            }
            
            // Build contact info string
            let contactInfo = '';
            if (student.phone) contactInfo += `ð± ${student.phone}`;
            if (student.next_of_kin) {
                if (contactInfo) contactInfo += ' | ';
                contactInfo += `ð¨âð©âð§âð¦ ${student.next_of_kin}`;
                if (student.next_of_kin_phone) {
                    contactInfo += ` (${student.next_of_kin_phone})`;
                }
            }
            
            studentCard.innerHTML = `
                <div class="student-id-badge">${student.student_id}</div>
                <div class="student-actions">
                    <button class="student-action-btn edit" title="Edit Student" onclick="event.stopPropagation(); showEditStudentModal('${student.student_id}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="student-action-btn delete" title="Delete Student" onclick="event.stopPropagation(); deleteStudentConfirm('${student.student_id}', '${student.name}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="student-header">
                    <div>
                        <div class="student-name" title="${student.name}">${student.name}</div>
                        <div class="student-level">${student.level}</div>
                        ${contactInfo ? `<div class="student-details-small">${contactInfo}</div>` : ''}
                    </div>
                    <div class="student-amount ${statusClass}">
                        ${statusText}
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill ${student.status}" style="width: ${student.progress}%"></div>
                </div>
                <div class="progress-text">
                    <span>Paid: $${student.totalPaid.toFixed(2)}</span>
                    <span>Term: $${student.termFees.toFixed(2)}</span>
                </div>
            `;
            
            // Add click event to show statement modal
            studentCard.addEventListener('click', function() {
                showStatementModal(student);
            });
            
            studentsContainer.appendChild(studentCard);
        });
        
        // Show message if no students found
        if (filteredStudents.length === 0) {
            studentsContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-user-slash"></i>
                    <h3>No students found</h3>
                    <p>${currentSearch ? 'Try a different search term' : 'No students match the current filter'}</p>
                </div>
            `;
        }
    }

    // Show edit student modal
    function showEditStudentModal(studentId) {
        const student = studentsData.find(s => s.student_id === studentId);
        if (!student) return;
        
        // Populate form fields
        document.getElementById('edit-student-id').value = student.student_id;
        document.getElementById('edit-student-name').value = student.name;
        document.getElementById('edit-student-phone').value = student.phone || '';
        document.getElementById('edit-student-level').value = student.level;
        document.getElementById('edit-student-address').value = student.address || '';
        document.getElementById('edit-student-next-of-kin').value = student.next_of_kin || '';
        document.getElementById('edit-student-next-of-kin-phone').value = student.next_of_kin_phone || '';
        
        // Show modal
        document.getElementById('edit-student-modal').classList.add('active');
    }

    // Handle student edit
    async function handleStudentEdit(e) {
        e.preventDefault();
        
        const studentId = document.getElementById('edit-student-id').value;
        const name = document.getElementById('edit-student-name').value.trim();
        const phone = document.getElementById('edit-student-phone').value.trim();
        const address = document.getElementById('edit-student-address').value.trim();
        const nextOfKin = document.getElementById('edit-student-next-of-kin').value.trim();
        const nextOfKinPhone = document.getElementById('edit-student-next-of-kin-phone').value.trim();
        
        if (!name) {
            showAlert('Error', 'Student name is required', 'error');
            return;
        }
        
        const editBtn = document.getElementById('edit-student-btn');
        const editText = document.getElementById('edit-student-text');
        const editLoading = document.getElementById('edit-student-loading');
        
        // Show loading state
        editBtn.disabled = true;
        editText.style.display = 'none';
        editLoading.style.display = 'inline-block';
        
        try {
            const params = new URLSearchParams({
                action: 'updateStudent',
                studentId: studentId,
                name: name,
                phone: phone,
                address: address,
                next_of_kin: nextOfKin,
                next_of_kin_phone: nextOfKinPhone
            });
            
            const response = await fetch(`${API_URL}?${params.toString()}`);
            const result = await response.json();
            
            if (result.status === 'success') {
                showAlert('Success', 'Student information updated successfully!', 'success');
                document.getElementById('edit-student-modal').classList.remove('active');
                loadStudentsData();
            } else {
                throw new Error(result.message || 'Failed to update student');
            }
            
        } catch (error) {
            console.error('Error updating student:', error);
            showAlert('Error', 'Failed to update student information. Please try again.', 'error');
        } finally {
            editBtn.disabled = false;
            editText.style.display = 'inline';
            editLoading.style.display = 'none';
        }
    }

    // Delete student confirmation
    function deleteStudentConfirm(studentId, studentName) {
        if (confirm(`Are you sure you want to delete "${studentName}" (ID: ${studentId})? This action will mark the student as deleted and they will no longer appear in the system.`)) {
            deleteStudent(studentId);
        }
    }

    // Delete student
    async function deleteStudent(studentId) {
        try {
            const params = new URLSearchParams({
                action: 'deleteStudent',
                studentId: studentId
            });
            
            const response = await fetch(`${API_URL}?${params.toString()}`);
            const result = await response.json();
            
            if (result.status === 'success') {
                showAlert('Success', 'Student deleted successfully!', 'success');
                loadStudentsData();
            } else {
                throw new Error(result.message || 'Failed to delete student');
            }
            
        } catch (error) {
            console.error('Error deleting student:', error);
            showAlert('Error', 'Failed to delete student. Please try again.', 'error');
        }
    }

    // Render levels table
    function renderLevelsTable() {
        const tableBody = document.getElementById('levels-table-body');
        tableBody.innerHTML = '';
        
        // Sort levels by name
        const sortedLevels = levelsData.sort((a, b) => {
            const aNum = parseInt(a.std_levels.replace(/[^0-9]/g, '')) || 0;
            const bNum = parseInt(b.std_levels.replace(/[^0-9]/g, '')) || 0;
            return aNum - bNum;
        });
        
        sortedLevels.forEach((level, index) => {
            // Count students in this level
            const studentCount = studentsData.filter(s => s.level === level.std_levels).length;
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${level.std_levels}</td>
                <td>$${parseFloat(level.term_fees).toFixed(2)}</td>
                <td>${studentCount} student${studentCount !== 1 ? 's' : ''}</td>
                <td>
                    <div class="table-actions">
                        <button class="table-btn edit" data-index="${index}">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="table-btn delete" data-index="${index}">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </td>
            `;
            
            tableBody.appendChild(row);
        });
        
        // Add event listeners for edit/delete buttons
        document.querySelectorAll('.table-btn.edit').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = this.getAttribute('data-index');
                showLevelModal(index);
            });
        });
        
        document.querySelectorAll('.table-btn.delete').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = this.getAttribute('data-index');
                deleteLevel(index);
            });
        });
    }

    // Show level modal for add/edit
    function showLevelModal(levelIndex = null) {
        const modal = document.getElementById('level-modal');
        const title = document.getElementById('level-modal-title');
        const nameInput = document.getElementById('level-name');
        const feesInput = document.getElementById('level-fees');
        
        if (levelIndex !== null) {
            // Edit mode
            const level = levelsData[levelIndex];
            title.textContent = 'Edit Grade Level';
            nameInput.value = level.std_levels;
            feesInput.value = level.term_fees;
            isEditingLevel = true;
            currentLevelId = level.id; // Use the ID from the level data
        } else {
            // Add mode
            title.textContent = 'Add Grade Level';
            nameInput.value = '';
            feesInput.value = '';
            isEditingLevel = false;
            currentLevelId = null;
        }
        
        modal.classList.add('active');
        nameInput.focus();
    }

    // Handle level save (add/edit)
    async function handleLevelSave(e) {
        e.preventDefault();
        
        const name = document.getElementById('level-name').value.trim();
        const fees = parseFloat(document.getElementById('level-fees').value);
        const levelBtn = document.getElementById('level-btn');
        const levelText = document.getElementById('level-text');
        const levelLoading = document.getElementById('level-loading');
        
        if (!name || !fees || fees < 0) {
            showAlert('Error', 'Please fill in all fields with valid values', 'error');
            return;
        }
        
        // Check if level already exists (for add mode)
        if (!isEditingLevel) {
            const existingLevel = levelsData.find(l => l.std_levels.toLowerCase() === name.toLowerCase());
            if (existingLevel) {
                showAlert('Error', 'This grade level already exists. Please use a different name.', 'error');
                return;
            }
        }
        
        // Show loading state
        levelBtn.disabled = true;
        levelText.style.display = 'none';
        levelLoading.style.display = 'inline-block';
        
        try {
            let result;
            
            if (isEditingLevel) {
                // Update existing level
                const params = new URLSearchParams({
                    action: 'updateLevel',
                    id: currentLevelId,
                    level: name,
                    fees: fees
                });
                
                const response = await fetch(`${API_URL}?${params.toString()}`);
                result = await response.json();
            } else {
                // Add new level
                const params = new URLSearchParams({
                    action: 'addLevel',
                    level: name,
                    fees: fees
                });
                
                const response = await fetch(`${API_URL}?${params.toString()}`);
                result = await response.json();
            }
            
            if (result.status === 'success') {
                showAlert('Success', `Grade level ${isEditingLevel ? 'updated' : 'added'} successfully!`, 'success');
                document.getElementById('level-modal').classList.remove('active');
                document.getElementById('level-form').reset();
                loadLevelsData();
                loadStudentsData(); // Reload to update level cards
            } else if (result.message && result.message.includes('already exists')) {
                throw new Error('Grade level already exists');
            } else {
                throw new Error(result.message || 'Failed to save level');
            }
            
        } catch (error) {
            console.error('Error saving level:', error);
            
            if (error.message.includes('already exists')) {
                showAlert('Error', 'This grade level already exists. Please use a different name.', 'error');
            } else {
                // Store request for retry
                storePendingRequest({
                    action: isEditingLevel ? 'updateLevel' : 'addLevel',
                    level: name,
                    fees: fees,
                    id: isEditingLevel ? currentLevelId : null
                });
                
                showAlert('Error', 'Failed to save grade level. Will retry automatically.', 'error');
            }
        } finally {
            levelBtn.disabled = false;
            levelText.style.display = 'inline';
            levelLoading.style.display = 'none';
        }
    }

    // Delete level
    async function deleteLevel(index) {
        const level = levelsData[index];
        if (!level) return;
        
        if (!confirm(`Are you sure you want to delete "${level.std_levels}"? This will not delete students enrolled in this level, but they will retain their current term fees.`)) {
            return;
        }
        
        try {
            const params = new URLSearchParams({
                action: 'deleteLevel',
                id: level.id // Use the ID from the level data
            });
            
            const response = await fetch(`${API_URL}?${params.toString()}`);
            const result = await response.json();
            
            if (result.status === 'success') {
                showAlert('Success', 'Grade level deleted successfully!', 'success');
                loadLevelsData();
                loadStudentsData(); // Reload to update level cards
            } else {
                throw new Error(result.message || 'Failed to delete level');
            }
            
        } catch (error) {
            console.error('Error deleting level:', error);
            showAlert('Error', 'Failed to delete grade level. Please try again.', 'error');
        }
    }

    // Show student suggestions for payment form
    function showStudentSuggestions() {
        const query = document.getElementById('payment-student').value.toLowerCase();
        const suggestions = document.getElementById('payment-suggestions');
        suggestions.innerHTML = '';
        
        if (query.length < 2) {
            suggestions.style.display = 'none';
            return;
        }
        
        const matchingStudents = studentsData.filter(student => 
            student.name.toLowerCase().includes(query) ||
            student.student_id.toLowerCase().includes(query)
        );
        
        if (matchingStudents.length === 0) {
            suggestions.style.display = 'none';
            return;
        }
        
        matchingStudents.forEach(student => {
            const item = document.createElement('div');
            item.className = 'suggestion-item';
            item.textContent = `${student.name} (${student.student_id}) - ${student.level}`;
            item.addEventListener('click', function() {
                document.getElementById('payment-student').value = student.name;
                document.getElementById('payment-level').value = student.level;
                document.getElementById('payment-student-id').value = student.student_id;
                document.getElementById('payment-tx-id').value = generateTransactionId();
                suggestions.style.display = 'none';
                selectedStudent = student;
            });
            suggestions.appendChild(item);
        });
        
        suggestions.style.display = 'block';
    }

    // Generate unique transaction ID
    function generateTransactionId() {
        const now = new Date();
        const datePart = now.getFullYear().toString().substr(-2) + 
                      (now.getMonth() + 1).toString().padStart(2, '0') +
                      now.getDate().toString().padStart(2, '0');
        const timePart = now.getHours().toString().padStart(2, '0') +
                       now.getMinutes().toString().padStart(2, '0');
        const randomPart = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
        return `tx-${datePart}${timePart}${randomPart}`;
    }

    // Handle student enrollment with custom fees support
    async function handleEnroll(e) {
        e.preventDefault();
        
        const name = document.getElementById('enroll-name').value.trim();
        const level = document.getElementById('enroll-level').value;
        const defaultFees = parseFloat(document.getElementById('enroll-term-fees').value) || 0;
        const customFeesToggle = document.getElementById('custom-fees-toggle').checked;
        const customFees = parseFloat(document.getElementById('custom-term-fees').value) || 0;
        const initialPayment = parseFloat(document.getElementById('enroll-initial-payment').value) || 0;
        const phone = document.getElementById('enroll-phone').value.trim();
        const address = document.getElementById('enroll-address').value.trim();
        const nextOfKin = document.getElementById('enroll-next-of-kin').value.trim();
        const nextOfKinPhone = document.getElementById('enroll-next-of-kin-phone').value.trim();
        
        if (!name || !level) {
            showAlert('Error', 'Please fill in all required fields', 'error');
            return;
        }
        
        // Determine which fees to use
        let finalFees = defaultFees;
        if (customFeesToggle && customFees > 0) {
            finalFees = customFees;
        }
        
        // Show loading state
        const enrollBtn = document.getElementById('enroll-btn');
        const enrollText = document.getElementById('enroll-text');
        const enrollLoading = document.getElementById('enroll-loading');
        
        enrollBtn.disabled = true;
        enrollText.style.display = 'none';
        enrollLoading.style.display = 'inline-block';
        
        try {
            const params = new URLSearchParams({
                action: 'enrollStudent',
                name: name,
                level: level,
                fees: finalFees, // Send the final fees amount
                initialPayment: initialPayment,
                phone: phone,
                address: address,
                next_of_kin: nextOfKin,
                next_of_kin_phone: nextOfKinPhone
            });
            
            const response = await fetch(`${API_URL}?${params.toString()}`);
            const result = await response.json();
            
            if (result.status === 'success') {
                showAlert('Success', 'Student enrolled successfully!', 'success');
                document.getElementById('enroll-form').reset();
                document.getElementById('custom-fees-input').classList.remove('active');
                document.getElementById('custom-fees-toggle').checked = false;
                loadStudentsData();
            } else {
                throw new Error(result.message || 'Failed to enroll student');
            }
            
        } catch (error) {
            console.error('Error enrolling student:', error);
            
            // Store request for retry
            storePendingRequest({
                action: 'enrollStudent',
                name: name,
                level: level,
                fees: finalFees,
                initialPayment: initialPayment,
                phone: phone,
                address: address,
                next_of_kin: nextOfKin,
                next_of_kin_phone: nextOfKinPhone
            });
            
            showAlert('Error', 'Failed to enroll student. Will retry automatically.', 'error');
        } finally {
            enrollBtn.disabled = false;
            enrollText.style.display = 'inline';
            enrollLoading.style.display = 'none';
        }
    }

    // Handle payment
    async function handlePayment(e) {
        e.preventDefault();
        
        if (!selectedStudent) {
            showAlert('Error', 'Please select a student from the suggestions', 'error');
            return;
        }
        
        const amount = parseFloat(document.getElementById('payment-amount').value);
        const txId = document.getElementById('payment-tx-id').value;
        const notes = document.getElementById('payment-notes').value;
        const paymentBtn = document.getElementById('payment-btn');
        const paymentText = document.getElementById('payment-text');
        const paymentLoading = document.getElementById('payment-loading');
        
        if (!amount || amount <= 0) {
            showAlert('Error', 'Please enter a valid payment amount', 'error');
            return;
        }
        
        // Show loading state
        paymentBtn.disabled = true;
        paymentText.style.display = 'none';
        paymentLoading.style.display = 'inline-block';
        
        try {
            const params = new URLSearchParams({
                action: 'recordPayment',
                studentId: selectedStudent.student_id,
                amount: amount,
                txId: txId,
                notes: notes
            });
            
            const response = await fetch(`${API_URL}?${params.toString()}`);
            const result = await response.json();
            
            if (result.status === 'success') {
                showAlert('Success', 'Payment recorded successfully!', 'success');
                document.getElementById('payment-form').reset();
                selectedStudent = null;
                loadStudentsData();
            } else {
                throw new Error(result.message || 'Failed to record payment');
            }
            
        } catch (error) {
            console.error('Error recording payment:', error);
            
            // Store request for retry
            storePendingRequest({
                action: 'recordPayment',
                studentId: selectedStudent.student_id,
                amount: amount,
                txId: txId,
                notes: notes
            });
            
            showAlert('Error', 'Failed to record payment. Will retry automatically.', 'error');
        } finally {
            paymentBtn.disabled = false;
            paymentText.style.display = 'inline';
            paymentLoading.style.display = 'none';
        }
    }

    // Show statement modal
    function showStatementModal(student) {
        selectedStudent = student;
        const modal = document.getElementById('statement-modal');
        
        // Populate student details
        document.getElementById('statement-student-id').textContent = student.student_id;
        document.getElementById('statement-name').textContent = student.name;
        document.getElementById('statement-level').textContent = student.level;
        document.getElementById('statement-term-fees').textContent = `$${student.termFees.toFixed(2)}`;
        document.getElementById('statement-total-paid').textContent = `$${student.totalPaid.toFixed(2)}`;
        document.getElementById('statement-total-due').textContent = `$${student.termFees.toFixed(2)}`;
        
        // Calculate balance and status
        const balance = student.balance;
        document.getElementById('statement-balance').textContent = `$${Math.abs(balance).toFixed(2)}`;
        
        let statusText = '';
        let statusClass = '';
        
        if (student.status === 'owing') {
            statusText = `Owing $${student.owingAmount.toFixed(2)}`;
            statusClass = 'owing';
        } else if (student.status === 'advance') {
            statusText = `Advance $${student.advanceAmount.toFixed(2)}`;
            statusClass = 'advance';
        } else {
            statusText = 'Fully Paid';
            statusClass = 'paid';
        }
        
        const statusElement = document.getElementById('statement-status');
        statusElement.textContent = statusText;
        statusElement.className = 'summary-value ' + statusClass;
        
        // Populate transactions table
        const transactionsTable = document.getElementById('statement-transactions');
        const noTransactionsMessage = document.getElementById('no-transactions-message');
        transactionsTable.innerHTML = '';
        
        if (student.transactions && student.transactions.length > 0) {
            noTransactionsMessage.style.display = 'none';
            
            student.transactions.forEach(transaction => {
                const row = document.createElement('tr');
                const date = new Date(transaction.date);
                const formattedDate = date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${transaction.tx_id || 'N/A'}</td>
                    <td>$${transaction.amount.toFixed(2)}</td>
                    <td>${transaction.notes || ''}</td>
                    <td>
                        <div class="transaction-actions">
                            <button class="transaction-btn download" title="Download Receipt" onclick="event.stopPropagation(); downloadTransactionReceipt('${student.student_id}', '${transaction.tx_id}')">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="transaction-btn delete" title="Delete Transaction" onclick="event.stopPropagation(); deleteTransactionConfirm('${student.student_id}', '${transaction.tx_id}', '${formattedDate}', ${transaction.amount})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                transactionsTable.appendChild(row);
            });
        } else {
            noTransactionsMessage.style.display = 'block';
        }
        
        modal.classList.add('active');
    }

    // Delete transaction confirmation
    function deleteTransactionConfirm(studentId, txId, date, amount) {
        if (confirm(`Are you sure you want to delete this transaction?\n\nDate: ${date}\nAmount: $${amount.toFixed(2)}\nTransaction ID: ${txId}\n\nThis action cannot be undone.`)) {
            deleteTransaction(studentId, txId);
        }
    }

    // Delete transaction
    async function deleteTransaction(studentId, txId) {
        try {
            const params = new URLSearchParams({
                action: 'deleteTransaction',
                studentId: studentId,
                txId: txId
            });
            
            const response = await fetch(`${API_URL}?${params.toString()}`);
            const result = await response.json();
            
            if (result.status === 'success') {
                showAlert('Success', 'Transaction deleted successfully!', 'success');
                // Refresh data
                loadStudentsData();
                // Update modal if open
                if (selectedStudent && selectedStudent.student_id === studentId) {
                    showStatementModal(selectedStudent);
                }
            } else {
                throw new Error(result.message || 'Failed to delete transaction');
            }
            
        } catch (error) {
            console.error('Error deleting transaction:', error);
            showAlert('Error', 'Failed to delete transaction. Please try again.', 'error');
        }
    }

    // Professional PDF Receipt
    function downloadTransactionReceipt(studentId, txId) {
        try {
            // Find the specific transaction
            const student = studentsData.find(s => s.student_id === studentId);
            if (!student) return;
            
            const transaction = student.transactions.find(t => t.tx_id === txId);
            if (!transaction) return;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();
            
            // Add header with gradient effect
            doc.setFillColor(26, 115, 232);
            doc.rect(0, 0, pageWidth, 50, 'F');
            
            // School name
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont('helvetica', 'bold');
            doc.text(COMPANY_DETAILS.name, pageWidth / 2, 20, { align: 'center' });
            
            // Receipt title
            doc.setFontSize(18);
            doc.text('OFFICIAL RECEIPT', pageWidth / 2, 35, { align: 'center' });
            
            // Add decorative line
            doc.setDrawColor(255, 255, 255);
            doc.setLineWidth(0.5);
            doc.line(40, 40, pageWidth - 40, 40);
            
            // Receipt details table - top section
            let yPos = 65;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            
            // Create a clean table layout
            const tableData = [
                ['Receipt No:', txId, 'Date:', new Date(transaction.date).toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                })],
                ['Time:', new Date(transaction.date).toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit'
                }), 'Student ID:', student.student_id]
            ];
            
            tableData.forEach(row => {
                doc.setFont('helvetica', 'bold');
                doc.text(row[0], 20, yPos);
                doc.setFont('helvetica', 'normal');
                doc.text(row[1], 60, yPos);
                
                doc.setFont('helvetica', 'bold');
                doc.text(row[2], pageWidth / 2 + 10, yPos);
                doc.setFont('helvetica', 'normal');
                doc.text(row[3], pageWidth / 2 + 50, yPos);
                yPos += 8;
            });
            
            // Student information section
            yPos += 10;
            doc.setFillColor(240, 240, 240);
            doc.rect(15, yPos - 5, pageWidth - 30, 30, 'F');
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.text('STUDENT INFORMATION', 20, yPos + 5);
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            yPos += 15;
            
            const studentInfo = [
                ['Name:', student.name],
                ['Grade Level:', student.level],
                ['Phone:', student.phone || 'N/A'],
                ['Address:', student.address || 'N/A']
            ];
            
            studentInfo.forEach(info => {
                doc.setFont('helvetica', 'bold');
                doc.text(info[0], 20, yPos);
                doc.setFont('helvetica', 'normal');
                doc.text(info[1], 60, yPos);
                yPos += 7;
            });
            
            // Payment details section
            yPos += 15;
            doc.setFillColor(240, 240, 240);
            doc.rect(15, yPos - 5, pageWidth - 30, 45, 'F');
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.text('PAYMENT DETAILS', 20, yPos + 5);
            
            // Payment table
            yPos += 15;
            doc.setFontSize(10);
            
            // Table header
            doc.setFillColor(26, 115, 232);
            doc.rect(20, yPos - 3, pageWidth - 40, 7, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.text('Description', 25, yPos + 2);
            doc.text('Amount', pageWidth - 25, yPos + 2, { align: 'right' });
            
            // Payment row
            yPos += 10;
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'normal');
            doc.text('School Term Fees Payment', 25, yPos);
            doc.text(`$${transaction.amount.toFixed(2)}`, pageWidth - 25, yPos, { align: 'right' });
            
            // Total row
            yPos += 10;
            doc.setDrawColor(200, 200, 200);
            doc.line(20, yPos - 3, pageWidth - 20, yPos - 3);
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text('TOTAL PAID', 25, yPos + 2);
            doc.text(`$${transaction.amount.toFixed(2)}`, pageWidth - 25, yPos + 2, { align: 'right' });
            
            // Payment status
            yPos += 15;
            const status = student.status === 'paid' ? 'FULLY PAID' : 
                          student.status === 'advance' ? 'ADVANCE PAYMENT' : 
                          'PARTIAL PAYMENT';
            
            const statusColor = student.status === 'paid' ? [39, 174, 96] : 
                               student.status === 'advance' ? [243, 156, 18] : 
                               [231, 76, 60];
            
            doc.setTextColor(statusColor[0], statusColor[1], statusColor[2]);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text(`â ${status}`, pageWidth / 2, yPos, { align: 'center' });
            
            // Balance information
            yPos += 10;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            
            const balanceInfo = `Term Fees: $${student.termFees.toFixed(2)} | Paid: $${student.totalPaid.toFixed(2)} | Balance: $${Math.abs(student.balance).toFixed(2)}`;
            doc.text(balanceInfo, pageWidth / 2, yPos, { align: 'center' });
            
            // Notes section
            if (transaction.notes) {
                yPos += 15;
                doc.setFont('helvetica', 'bold');
                doc.text('Notes:', 20, yPos);
                doc.setFont('helvetica', 'normal');
                doc.text(transaction.notes, 40, yPos);
            }
            
            // Footer
            yPos = 270;
            doc.setDrawColor(200, 200, 200);
            doc.line(20, yPos, pageWidth - 20, yPos);
            
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            yPos += 7;
            doc.text('This is an official receipt. Please keep for your records.', pageWidth / 2, yPos, { align: 'center' });
            yPos += 5;
            doc.text(`For inquiries, contact: ${COMPANY_DETAILS.phone} | ${COMPANY_DETAILS.address}`, pageWidth / 2, yPos, { align: 'center' });
            yPos += 5;
            doc.text(COMPANY_DETAILS.footer, pageWidth / 2, yPos, { align: 'center' });
            yPos += 5;
            doc.text(`Generated on ${new Date().toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            })}`, pageWidth / 2, yPos, { align: 'center' });
            
            // Save the PDF
            doc.save(`Receipt_${txId}.pdf`);
            
        } catch (error) {
            console.error('Error generating receipt:', error);
            showAlert('Error', 'Failed to generate receipt. Please try again.', 'error');
        }
    }

    // Professional Student Statement PDF
    function exportStudentStatement(student) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const pageWidth = doc.internal.pageSize.getWidth();
        
        // Add header with gradient effect
        doc.setFillColor(26, 115, 232);
        doc.rect(0, 0, pageWidth, 50, 'F');
        
        // School name
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(24);
        doc.setFont('helvetica', 'bold');
        doc.text(COMPANY_DETAILS.name, pageWidth / 2, 20, { align: 'center' });
        
        // Statement title
        doc.setFontSize(18);
        doc.text('STUDENT STATEMENT', pageWidth / 2, 35, { align: 'center' });
        
        // Add decorative line
        doc.setDrawColor(255, 255, 255);
        doc.setLineWidth(0.5);
        doc.line(40, 40, pageWidth - 40, 40);
        
        // Student information section
        let yPos = 65;
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(10);
        
        // Student info table
        const studentInfo = [
            ['Student ID:', student.student_id, 'Name:', student.name],
            ['Grade Level:', student.level, 'Term Fees:', `$${student.termFees.toFixed(2)}`],
            ['Phone:', student.phone || 'N/A', 'Next of Kin:', student.next_of_kin || 'N/A'],
            ['Address:', student.address || 'N/A', 'Kin Phone:', student.next_of_kin_phone || 'N/A']
        ];
        
        studentInfo.forEach(row => {
            doc.setFont('helvetica', 'bold');
            doc.text(row[0], 20, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(row[1], 50, yPos);
            
            doc.setFont('helvetica', 'bold');
            doc.text(row[2], pageWidth / 2 + 10, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(row[3], pageWidth / 2 + 40, yPos);
            yPos += 8;
        });
        
        // Financial summary section
        yPos += 15;
        doc.setFillColor(240, 240, 240);
        doc.rect(15, yPos - 5, pageWidth - 30, 35, 'F');
        
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(12);
        doc.text('FINANCIAL SUMMARY', 20, yPos + 5);
        
        // Summary table
        yPos += 15;
        doc.setFontSize(10);
        
        const summaryData = [
            ['Total Term Fees:', `$${student.termFees.toFixed(2)}`],
            ['Total Paid:', `$${student.totalPaid.toFixed(2)}`],
            ['Balance:', `$${Math.abs(student.balance).toFixed(2)}`]
        ];
        
        summaryData.forEach((row, index) => {
            doc.setFont('helvetica', index === 2 ? 'bold' : 'normal');
            doc.text(row[0], 25, yPos);
            doc.text(row[1], pageWidth - 25, yPos, { align: 'right' });
            yPos += 8;
        });
        
        // Status badge
        yPos += 5;
        const status = student.status === 'paid' ? 'FULLY PAID' : 
                      student.status === 'advance' ? 'ADVANCE PAYMENT' : 
                      `OWING $${student.owingAmount.toFixed(2)}`;
        
        const statusColor = student.status === 'paid' ? [39, 174, 96] : 
                           student.status === 'advance' ? [243, 156, 18] : 
                           [231, 76, 60];
        
        doc.setFillColor(statusColor[0], statusColor[1], statusColor[2]);
        doc.rect(pageWidth - 60, yPos - 5, 50, 8, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFont('helvetica', 'bold');
        doc.text(status, pageWidth - 35, yPos + 2, { align: 'center' });
        
        // Transactions section
        yPos += 20;
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text('TRANSACTION HISTORY', 20, yPos);
        
        if (student.transactions && student.transactions.length > 0) {
            yPos += 10;
            
            // Table header
            doc.setFillColor(26, 115, 232);
            doc.rect(15, yPos - 3, pageWidth - 30, 7, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.text('Date', 20, yPos + 2);
            doc.text('Receipt No', 60, yPos + 2);
            doc.text('Amount', pageWidth - 25, yPos + 2, { align: 'right' });
            
            // Transaction rows
            yPos += 10;
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'normal');
            
            let transactionCount = 0;
            for (const transaction of student.transactions) {
                if (yPos > 250 && transactionCount < student.transactions.length - 1) {
                    doc.addPage();
                    yPos = 20;
                    
                    // Add header to new page
                    doc.setFillColor(26, 115, 232);
                    doc.rect(0, 0, pageWidth, 20, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Transaction History (Continued)', pageWidth / 2, 12, { align: 'center' });
                    
                    // Table header on new page
                    yPos += 15;
                    doc.setFillColor(26, 115, 232);
                    doc.rect(15, yPos - 3, pageWidth - 30, 7, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(9);
                    doc.text('Date', 20, yPos + 2);
                    doc.text('Receipt No', 60, yPos + 2);
                    doc.text('Amount', pageWidth - 25, yPos + 2, { align: 'right' });
                    yPos += 10;
                }
                
                const date = new Date(transaction.date);
                const formattedDate = date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                doc.text(formattedDate, 20, yPos);
                doc.text(transaction.tx_id || 'N/A', 60, yPos);
                doc.text(`$${transaction.amount.toFixed(2)}`, pageWidth - 25, yPos, { align: 'right' });
                yPos += 8;
                transactionCount++;
            }
        } else {
            yPos += 15;
            doc.setFont('helvetica', 'normal');
            doc.text('No transactions found.', 20, yPos);
        }
        
        // Footer
        yPos = 280;
        doc.setDrawColor(200, 200, 200);
        doc.line(20, yPos, pageWidth - 20, yPos);
        
        doc.setFontSize(8);
        doc.setTextColor(150, 150, 150);
        yPos += 7;
        doc.text('This is an official statement from Bethel Junior School.', pageWidth / 2, yPos, { align: 'center' });
        yPos += 5;
        doc.text(`For inquiries, contact: ${COMPANY_DETAILS.phone} | ${COMPANY_DETAILS.address}`, pageWidth / 2, yPos, { align: 'center' });
        yPos += 5;
        doc.text(COMPANY_DETAILS.footer, pageWidth / 2, yPos, { align: 'center' });
        yPos += 5;
        doc.text(`Generated on ${new Date().toLocaleDateString()}`, pageWidth / 2, yPos, { align: 'center' });
        
        // Add page numbers
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text(`Page ${i} of ${pageCount}`, pageWidth / 2, 290, { align: 'center' });
        }
        
        // Save the PDF
        doc.save(`${student.name.replace(/\s+/g, '_')}_Statement_${student.student_id}.pdf`);
    }

    // Professional All Students Report PDF
    function exportAllStudentsData() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('landscape');
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        
        // Add header
        doc.setFillColor(26, 115, 232);
        doc.rect(0, 0, pageWidth, 40, 'F');
        
        // School name
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(24);
        doc.setFont('helvetica', 'bold');
        doc.text(COMPANY_DETAILS.name, pageWidth / 2, 18, { align: 'center' });
        
        // Report title
        doc.setFontSize(16);
        doc.text('FINANCIAL REPORT - ALL STUDENTS', pageWidth / 2, 32, { align: 'center' });
        
        // Report summary
        let yPos = 55;
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(10);
        
        const totalOwing = studentsData.filter(s => s.status === 'owing')
            .reduce((sum, s) => sum + s.owingAmount, 0);
        const totalPaid = studentsData.reduce((sum, s) => sum + s.totalPaid, 0);
        
        const summaryData = [
            ['Total Students:', studentsData.length.toString()],
            ['Students Owing:', studentsData.filter(s => s.status === 'owing').length.toString()],
            ['Fully Paid:', studentsData.filter(s => s.status === 'paid').length.toString()],
            ['Advance Payments:', studentsData.filter(s => s.status === 'advance').length.toString()],
            ['Total Amount Owing:', `$${totalOwing.toFixed(2)}`],
            ['Total Amount Paid:', `$${totalPaid.toFixed(2)}`]
        ];
        
        // Create summary table
        const colWidth = (pageWidth - 40) / 3;
        summaryData.forEach((row, index) => {
            const col = index % 3;
            const rowNum = Math.floor(index / 3);
            
            const xPos = 20 + (col * colWidth);
            const currentYPos = yPos + (rowNum * 10);
            
            doc.setFont('helvetica', 'bold');
            doc.text(row[0], xPos, currentYPos);
            doc.setFont('helvetica', 'normal');
            doc.text(row[1], xPos + 50, currentYPos);
        });
        
        yPos += 30;
        
        // Students table
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(12);
        doc.text('STUDENT DETAILS', 20, yPos);
        
        yPos += 10;
        
        // Table header
        doc.setFillColor(26, 115, 232);
        doc.rect(15, yPos - 5, pageWidth - 30, 8, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(9);
        
        const headers = ['ID', 'Name', 'Level', 'Paid', 'Fees', 'Balance', 'Status'];
        const colWidths = [20, 50, 25, 25, 25, 25, 25];
        let xPos = 20;
        
        headers.forEach((header, index) => {
            doc.text(header, xPos, yPos + 2);
            xPos += colWidths[index];
        });
        
        // Student rows
        yPos += 10;
        doc.setTextColor(0, 0, 0);
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(8);
        
        let rowCount = 0;
        const maxRowsPerPage = 15;
        
        studentsData.forEach((student, index) => {
            if (rowCount >= maxRowsPerPage) {
                doc.addPage('landscape');
                yPos = 20;
                rowCount = 0;
                
                // Add header to new page
                doc.setFillColor(26, 115, 232);
                doc.rect(15, yPos - 5, pageWidth - 30, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                
                xPos = 20;
                headers.forEach((header, hIndex) => {
                    doc.text(header, xPos, yPos + 2);
                    xPos += colWidths[hIndex];
                });
                
                yPos += 10;
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(8);
            }
            
            xPos = 20;
            
            // ID
            doc.text(student.student_id, xPos, yPos);
            xPos += colWidths[0];
            
            // Name (truncated)
            const name = student.name.length > 20 ? student.name.substring(0, 20) + '...' : student.name;
            doc.text(name, xPos, yPos);
            xPos += colWidths[1];
            
            // Level
            doc.text(student.level, xPos, yPos);
            xPos += colWidths[2];
            
            // Paid
            doc.text(`$${student.totalPaid.toFixed(2)}`, xPos, yPos);
            xPos += colWidths[3];
            
            // Fees
            doc.text(`$${student.termFees.toFixed(2)}`, xPos, yPos);
            xPos += colWidths[4];
            
            // Balance
            doc.text(`$${Math.abs(student.balance).toFixed(2)}`, xPos, yPos);
            xPos += colWidths[5];
            
            // Status
            let statusText = '';
            let statusColor = [0, 0, 0];
            
            if (student.status === 'owing') {
                statusText = 'Owing';
                statusColor = [231, 76, 60];
            } else if (student.status === 'advance') {
                statusText = 'Advance';
                statusColor = [243, 156, 18];
            } else {
                statusText = 'Paid';
                statusColor = [39, 174, 96];
            }
            
            doc.setTextColor(statusColor[0], statusColor[1], statusColor[2]);
            doc.text(statusText, xPos, yPos);
            doc.setTextColor(0, 0, 0);
            
            yPos += 6;
            rowCount++;
        });
        
        // Footer
        yPos = pageHeight - 20;
        doc.setDrawColor(200, 200, 200);
        doc.line(20, yPos, pageWidth - 20, yPos);
        
        doc.setFontSize(8);
        doc.setTextColor(150, 150, 150);
        yPos += 7;
        doc.text(`For inquiries, contact: ${COMPANY_DETAILS.phone} | ${COMPANY_DETAILS.address}`, pageWidth / 2, yPos, { align: 'center' });
        yPos += 5;
        doc.text(COMPANY_DETAILS.footer, pageWidth / 2, yPos, { align: 'center' });
        yPos += 5;
        doc.text(`Generated on ${new Date().toLocaleDateString()}`, pageWidth / 2, yPos, { align: 'center' });
        
        // Add page numbers
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text(`Page ${i} of ${pageCount}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
        }
        
        // Save the PDF
        doc.save('All_Students_Financial_Report.pdf');
    }

    // Show alert
    function showAlert(title, message, type = 'success') {
        const alertModal = document.getElementById('alertModal');
        const alertTitle = document.getElementById('alertTitle');
        const alertMessage = document.getElementById('alertMessage');
        const alertIcon = document.getElementById('alertIcon');
        
        alertTitle.textContent = title;
        alertMessage.innerHTML = message;
        
        alertIcon.className = `alert-icon ${type}`;
        alertIcon.innerHTML = type === 'success' ? '<i class="fas fa-check-circle"></i>' :
                             type === 'error' ? '<i class="fas fa-exclamation-circle"></i>' :
                             type === 'info' ? '<i class="fas fa-info-circle"></i>' :
                             '<i class="fas fa-exclamation-triangle"></i>';
        
        alertModal.classList.add('active');
        
        if (type === 'success' || type === 'info') {
            setTimeout(closeAlertModal, 3000);
        }
    }

    // Close alert modal
    function closeAlertModal() {
        document.getElementById('alertModal').classList.remove('active');
    }

    // Set theme
    function setTheme(theme) {
        if (theme === 'dark') {
            document.body.classList.remove('light-theme');
            document.body.classList.add('dark-theme');
        } else {
            document.body.classList.remove('dark-theme');
            document.body.classList.add('light-theme');
        }
        
        localStorage.setItem('theme', theme);
    }

    // Load settings
    function loadSettings() {
        const settings = JSON.parse(localStorage.getItem('settings') || '{}');
        
        if (settings.schoolName) {
            document.getElementById('school-name').value = settings.schoolName;
        }
        if (settings.schoolAddress) {
            document.getElementById('school-address').value = settings.schoolAddress;
        }
        if (settings.schoolPhone) {
            document.getElementById('school-phone').value = settings.schoolPhone;
        }
    }

    // Save settings
    function saveSettings() {
        const settings = {
            schoolName: document.getElementById('school-name').value,
            schoolAddress: document.getElementById('school-address').value,
            schoolPhone: document.getElementById('school-phone').value
        };
        
        localStorage.setItem('settings', JSON.stringify(settings));
        showAlert('Success', 'Settings saved successfully!', 'success');
    }

    // Store pending request for retry
    async function storePendingRequest(request) {
        try {
            // Store in IndexedDB if available
            if (db) {
                await storeData('pendingRequests', {
                    ...request,
                    timestamp: new Date().toISOString(),
                    status: 'pending'
                });
            } else {
                // Fallback to localStorage
                pendingRequests.push(request);
                localStorage.setItem('pendingRequests', JSON.stringify(pendingRequests));
            }
        } catch (error) {
            console.error('Error storing pending request:', error);
            // Fallback to localStorage
            pendingRequests.push(request);
            localStorage.setItem('pendingRequests', JSON.stringify(pendingRequests));
        }
    }

    // Load pending requests
    async function loadPendingRequests() {
        try {
            if (db) {
                const requests = await getAllData('pendingRequests');
                pendingRequests = requests || [];
            } else {
                const stored = localStorage.getItem('pendingRequests');
                if (stored) {
                    pendingRequests = JSON.parse(stored);
                }
            }
        } catch (error) {
            console.error('Error loading pending requests:', error);
            const stored = localStorage.getItem('pendingRequests');
            if (stored) {
                pendingRequests = JSON.parse(stored);
            }
        }
    }

    // Retry pending requests
    async function retryPendingRequests() {
        if (pendingRequests.length === 0 || !onlineStatus || isSyncing) return;
        
        isSyncing = true;
        
        const successful = [];
        
        for (let i = 0; i < pendingRequests.length; i++) {
            const request = pendingRequests[i];
            
            try {
                const params = new URLSearchParams(request);
                const response = await fetch(`${API_URL}?${params.toString()}`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    successful.push(i);
                }
            } catch (error) {
                console.error('Failed to retry request:', error);
            }
        }
        
        // Remove successful requests
        if (successful.length > 0) {
            pendingRequests = pendingRequests.filter((_, index) => !successful.includes(index));
            
            try {
                if (db) {
                    // Clear and re-add remaining requests
                    const transaction = db.transaction(['pendingRequests'], 'readwrite');
                    const store = transaction.objectStore('pendingRequests');
                    await store.clear();
                    
                    for (const request of pendingRequests) {
                        await store.add(request);
                    }
                } else {
                    localStorage.setItem('pendingRequests', JSON.stringify(pendingRequests));
                }
            } catch (error) {
                console.error('Error updating pending requests:', error);
            }
        }
        
        isSyncing = false;
    }

    // Start sync interval
    function startSyncInterval() {
        // Clear any existing interval
        if (syncInterval) {
            clearInterval(syncInterval);
        }
        
        // Load pending requests
        loadPendingRequests();
        
        // Sync immediately if online
        if (onlineStatus) {
            retryPendingRequests();
        }
        
        // Set up sync interval (every 3 seconds)
        syncInterval = setInterval(() => {
            if (onlineStatus) {
                retryPendingRequests();
                
                // Refresh data every 30 seconds when online
                if (Date.now() % 30000 < 3000) {
                    loadStudentsData();
                    loadLevelsData();
                }
            }
        }, 3000);
    }

    // Check logout allowed
    async function checkLogoutAllowed() {
        if (!onlineStatus) {
            showAlert('Warning', 'Cannot logout while offline. Please connect to internet to logout.', 'warning');
            return false;
        }
        
        // Check if there are pending requests that need to be synced
        if (pendingRequests.length > 0) {
            const confirmLogout = confirm(`You have ${pendingRequests.length} pending requests that haven't been synced to the cloud. Logging out will keep them stored locally. Are you sure you want to logout?`);
            if (!confirmLogout) {
                return false;
            }
        }
        
        return true;
    }

    // Handle logout
    async function handleLogout() {
        // Check if logout is allowed
        const allowed = await checkLogoutAllowed();
        if (!allowed) {
            return;
        }
        
        try {
            // Clear user data
            currentUser = null;
            localStorage.removeItem('school_currentUser');
            sessionStorage.removeItem('school_currentUser');
            
            // Stop sync interval
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
            }
            
            // Reset variables
            studentsData = [];
            aggregatedStudents = {};
            levelsData = [];
            pendingRequests = [];
            selectedLevel = null;
            
            // Show login modal
            document.getElementById('app-section').style.display = 'none';
            document.getElementById('loginModal').style.display = 'flex';
            
            // Clear login form
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('remember-me').checked = false;
            
            // Close mobile menu
            closeMobileMenu();
            
            showAlert('Success', 'Logged out successfully', 'success');
            
        } catch (error) {
            console.error('Error during logout:', error);
            showAlert('Error', 'Error during logout', 'error');
        }
    }

    // Make functions global
    window.login = login;
    window.logout = handleLogout;
    window.closeAlertModal = closeAlertModal;
    window.downloadTransactionReceipt = downloadTransactionReceipt;
    window.deleteTransactionConfirm = deleteTransactionConfirm;
    window.deleteTransaction = deleteTransaction;
    window.showEditStudentModal = showEditStudentModal;
    window.deleteStudentConfirm = deleteStudentConfirm;
    window.deleteStudent = deleteStudent;
</script>
</body>
</html>

